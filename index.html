<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Registro Fitossanitário - SPG Oásis</title>
    
    <!-- Configurações PWA -->
    <link rel="icon" type="image/png" href="https://i.imgur.com/f7UnnL0.png">
    <link rel="apple-touch-icon" href="https://i.imgur.com/f7UnnL0.png">
    <meta name="theme-color" content="#ffffff">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="SPG Fito">
    
    <!-- Bibliotecas Externas -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <!-- HTML2Canvas + jsPDF -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    
    <style>
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; -webkit-tap-highlight-color: transparent; }
        .hide-scrollbar::-webkit-scrollbar { display: none; }
        .hide-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        input, select { line-height: 1.5; }
        
        /* Estilos para o Relatório Técnico (PDF) */
        #technical-report-template {
            width: 794px; /* A4 Width at 96dpi approx */
            min-height: 1123px; /* A4 Height */
            background: white;
            padding: 40px;
            box-sizing: border-box;
            position: absolute;
            /* Mantém fora da tela, mas renderizável */
            top: -9999px;
            left: -9999px;
            font-family: 'Helvetica', 'Arial', sans-serif;
            color: #333;
        }
        .tech-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
            font-size: 11px;
        }
        .tech-table th {
            background-color: #f1f5f9;
            color: #475569;
            font-weight: bold;
            text-transform: uppercase;
            padding: 8px;
            border: 1px solid #e2e8f0;
            text-align: left;
        }
        .tech-table td {
            padding: 8px;
            border: 1px solid #e2e8f0;
            vertical-align: top;
        }
        .tech-header {
            border-bottom: 2px solid #0f172a;
            padding-bottom: 20px;
            margin-bottom: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        /* Animação suave para troca de inputs */
        .fade-in {
            animation: fadeIn 0.2s ease-in-out;
        }
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
    </style>
</head>
<body class="bg-slate-100 text-slate-800 min-h-screen pb-20 select-none">

    <!-- Navbar -->
    <div class="bg-white border-b border-slate-200 px-4 py-3 flex flex-col md:flex-row justify-between items-center shadow-sm sticky top-0 z-40 gap-3">
        <div class="flex items-center gap-3 w-full md:w-auto">
            <img src="https://i.imgur.com/f7UnnL0.png" alt="Logo SPG" class="w-8 h-8 rounded-lg shadow-sm border border-slate-100">
            <div>
                <h1 class="text-sm font-bold text-slate-800 leading-tight">SPG FITOSSANITÁRIO</h1>
                <p class="text-[10px] text-slate-500 font-medium">Registro de Aplicações de Defensivos</p>
            </div>
        </div>
        <div class="flex gap-2 w-full md:w-auto overflow-x-auto pb-1 md:pb-0">
            <!-- Botão WhatsApp -->
            <button id="btnZap" onclick="copyToWhatsApp()" class="flex-1 md:flex-none flex items-center justify-center gap-2 px-3 py-2 bg-emerald-500 hover:bg-emerald-600 text-white rounded-lg text-xs font-bold shadow-lg shadow-emerald-500/20 transition-all active:scale-95 active:bg-emerald-700 whitespace-nowrap">
                <i data-lucide="message-circle" class="w-4 h-4"></i>
                <span>Zap</span>
            </button>
            
            <!-- Botão Imagem (Laranja) -->
            <button onclick="downloadImage()" class="flex-1 md:flex-none flex items-center justify-center gap-2 px-3 py-2 bg-orange-500 hover:bg-orange-600 text-white rounded-lg text-xs font-bold shadow-lg shadow-orange-500/20 transition-all active:scale-95 active:bg-orange-700 whitespace-nowrap">
                <i data-lucide="image" class="w-4 h-4"></i>
                <span>Imagem</span>
            </button>

            <!-- Botão PDF -->
            <button id="pdfBtn" type="button" onclick="downloadPDF()" class="flex-1 md:flex-none flex items-center justify-center gap-2 px-3 py-2 bg-red-600 hover:bg-red-700 text-white rounded-lg text-xs font-bold shadow-lg shadow-red-600/20 transition-all active:scale-95 active:bg-red-800 whitespace-nowrap">
                <i data-lucide="file-down" class="w-4 h-4"></i>
                <span>PDF Técnico</span>
            </button>
        </div>
    </div>

    <div class="container mx-auto p-4 flex flex-col lg:flex-row gap-8 mt-4">
        
        <!-- COLUNA DA ESQUERDA: CONTROLES -->
        <div class="w-full lg:w-2/5 space-y-4">
            
            <!-- 1. DADOS GERAIS E OPERACIONAIS (INDEPENDENTE) -->
            <div id="generalDataCard" class="bg-blue-50 p-5 rounded-2xl shadow-sm border border-blue-100 transition-colors">
                <h2 class="text-sm font-bold text-blue-800 mb-3 flex items-center gap-2">
                    <i data-lucide="clipboard-check" class="text-blue-600"></i> Dados Gerais da Aplicação
                </h2>
                
                <!-- GERAL -->
                <div class="grid grid-cols-2 gap-3 mb-5">
                    <div class="relative">
                        <label class="text-[10px] font-bold text-blue-600 uppercase tracking-wide mb-1 block">Local <span class="text-red-500">*</span></label>
                        <select id="partner" required onchange="clearError('partner'); updateGlobalState()" class="w-full p-2 border border-blue-200 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none text-sm bg-white">
                            <option value="">Selecione...</option>
                            <option value="SPG Oásis">SPG Oásis</option>
                            <option value="SPG Sede">SPG Sede</option>
                        </select>
                        <span id="error-partner" class="text-[9px] text-red-500 font-bold hidden absolute -bottom-4 left-0">Preencha este campo</span>
                    </div>
                    <div class="relative">
                        <label class="text-[10px] font-bold text-blue-600 uppercase tracking-wide mb-1 block">Data <span class="text-red-500">*</span></label>
                        <input type="date" id="appDate" required onchange="clearError('appDate'); updateGlobalState()" class="w-full p-2 border border-blue-200 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none text-sm bg-white text-slate-600">
                        <span id="error-appDate" class="text-[9px] text-red-500 font-bold hidden absolute -bottom-4 left-0">Preencha este campo</span>
                    </div>
                </div>

                <!-- OPERACIONAL -->
                <div class="grid grid-cols-2 gap-3 mb-5">
                    <div class="relative">
                        <label class="text-[10px] font-bold text-slate-500 mb-1 block">Solicitante</label>
                        <select id="requestor" onchange="toggleOtherRequestorInput(); clearError('requestor'); updateGlobalState();" class="w-full p-2 border border-slate-300 rounded-lg text-sm bg-white focus:ring-2 focus:ring-blue-500 outline-none">
                            <option value="">Selecione...</option>
                            <option value="José Márcio">José Márcio</option> 
                            <option value="Guilherme Ramos">Guilherme Ramos</option> <!-- ADICIONADO -->
                            <option value="Outro">Outro (Digitar)</option>
                        </select>
                        <div id="requestor-custom-div" class="hidden relative w-full fade-in">
                            <input type="text" id="otherRequestorInput" oninput="clearError('otherRequestorInput'); updateGlobalState();" class="w-full p-2 pr-8 border border-slate-300 rounded-lg text-sm bg-white focus:ring-2 focus:ring-blue-500 outline-none" placeholder="Nome do Solicitante">
                            <button type="button" onclick="resetRequestorField(); updateGlobalState();" class="absolute right-2 top-1/2 -translate-y-1/2 text-slate-400 hover:text-red-500">
                                <i data-lucide="x-circle" width="14"></i>
                            </button>
                        </div>
                        <span id="error-requestor" class="text-[9px] text-red-500 font-bold hidden absolute -bottom-4 left-0">Preencha este campo</span>
                         <span id="error-otherRequestorInput" class="text-[9px] text-red-500 font-bold hidden absolute -bottom-4 left-0">Preencha este campo</span>
                    </div>

                    <div class="relative">
                        <label class="text-[10px] font-bold text-slate-500 mb-1 block">Aplicador</label>
                        <select id="applicator" onchange="toggleOtherApplicatorInput(); clearError('applicator'); updateGlobalState();" class="w-full p-2 border border-slate-300 rounded-lg text-sm bg-white focus:ring-2 focus:ring-blue-500 outline-none">
                            <option value="">Selecione...</option>
                            <option value="Equipe Erisvaldo">Equipe Erisvaldo</option>
                            <option value="Hugo Melo">Hugo Melo</option> <!-- ADICIONADO -->
                            <option value="Outro">Outro (Digitar)</option>
                        </select>
                        <div id="applicator-custom-div" class="hidden relative w-full fade-in">
                            <input type="text" id="otherApplicatorInput" oninput="clearError('otherApplicatorInput'); updateGlobalState();" class="w-full p-2 pr-8 border border-slate-300 rounded-lg text-sm bg-white focus:ring-2 focus:ring-blue-500 outline-none" placeholder="Nome do Aplicador">
                            <button type="button" onclick="resetApplicatorField(); updateGlobalState();" class="absolute right-2 top-1/2 -translate-y-1/2 text-slate-400 hover:text-red-500">
                                <i data-lucide="x-circle" width="14"></i>
                            </button>
                        </div>
                        <span id="error-applicator" class="text-[9px] text-red-500 font-bold hidden absolute -bottom-4 left-0">Preencha este campo</span>
                        <span id="error-otherApplicatorInput" class="text-[9px] text-red-500 font-bold hidden absolute -bottom-4 left-0">Preencha este campo</span>
                    </div>
                </div>

                <div class="grid grid-cols-3 gap-2 mb-3">
                    <div class="relative">
                        <label class="text-[10px] font-bold text-slate-500 mb-1 block">Início</label>
                        <input type="time" id="startTime" onchange="clearError('startTime'); calculateDuration(); updateGlobalState();" class="w-full p-2 border border-slate-300 rounded-lg text-sm bg-white focus:ring-2 focus:ring-blue-500 outline-none">
                        <span id="error-startTime" class="text-[9px] text-red-500 font-bold hidden absolute -bottom-4 left-0">Preencha este campo</span>
                    </div>
                    <div class="relative">
                        <label class="text-[10px] font-bold text-slate-500 mb-1 block">Fim</label>
                        <input type="time" id="endTime" onchange="clearError('endTime'); calculateDuration(); updateGlobalState();" class="w-full p-2 border border-slate-300 rounded-lg text-sm bg-white focus:ring-2 focus:ring-blue-500 outline-none">
                        <span id="error-endTime" class="text-[9px] text-red-500 font-bold hidden absolute -bottom-4 left-0">Preencha este campo</span>
                    </div>
                    <div>
                        <label class="text-[10px] font-bold text-slate-500 mb-1 block">Total</label>
                        <input type="text" id="totalDuration" readonly placeholder="--:--" class="w-full p-2 border border-slate-200 bg-slate-100 rounded-lg text-sm text-slate-600 focus:outline-none font-semibold">
                    </div>
                </div>
                
                <!-- AVISO DE ERRO DENTRO DO CARD -->
                <div id="generalDataError" class="hidden mt-3 bg-red-50 border border-red-200 text-red-600 px-3 py-2 rounded-lg text-xs flex items-center gap-2 animate-pulse">
                    <i data-lucide="alert-triangle" width="16" class="shrink-0"></i>
                    <span>Por favor, preencha o <b>Local</b> e a <b>Data</b> acima para continuar.</span>
                </div>
            </div>

            <!-- 2. FORMULÁRIO DE LANÇAMENTO (BLOCO) -->
            <div id="formContainer" class="bg-white p-6 rounded-2xl shadow-sm border border-slate-200 transition-colors duration-300">
                <div class="flex justify-between items-center mb-4">
                    <h2 id="formTitle" class="text-lg font-bold text-slate-800 flex items-center gap-2">
                        <i data-lucide="spray-can" class="text-blue-600"></i> Nova Aplicação
                    </h2>
                    <button type="button" onclick="clearBlockForm()" class="text-xs font-semibold text-slate-400 hover:text-red-500 transition-colors flex items-center gap-1">
                        <i data-lucide="eraser" class="w-3 h-3"></i> Limpar
                    </button>
                </div>
                
                <!-- Adicionado novalidate para controle JS -->
                <form id="appForm" onsubmit="addItem(event)" class="space-y-4" novalidate>
                    
                    <!-- LINHA 3: CULTURA E BLOCO -->
                    <div class="grid grid-cols-2 gap-3 mb-5">
                        <div class="relative">
                            <label class="text-xs font-bold text-slate-500 uppercase mb-1 block">Cultura</label>
                            
                            <!-- SELECT CULTURA -->
                            <select id="crop" onchange="toggleOtherCropInput(); clearError('crop'); handleCropChange();" required class="w-full p-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none text-sm bg-white">
                                <option value="Brócolis">Brócolis</option>
                                <option value="Couve-Flor">Couve-Flor</option>
                                <option value="Pepino">Pepino</option>
                                <option value="Outros">Outros</option>
                            </select>
                            
                            <!-- INPUT CULTURA (OVERLAY) -->
                            <div id="crop-custom-div" class="hidden relative w-full fade-in">
                                <input type="text" id="otherCropInput" oninput="clearError('otherCropInput')" class="w-full p-2 pr-8 border border-slate-300 rounded-lg text-sm bg-white focus:ring-2 focus:ring-blue-500 outline-none" placeholder="Qual cultura?">
                                <button type="button" onclick="resetCropField(); handleCropChange();" class="absolute right-2 top-1/2 -translate-y-1/2 text-slate-400 hover:text-red-500">
                                    <i data-lucide="x-circle" width="14"></i>
                                </button>
                            </div>

                            <span id="error-crop" class="text-[9px] text-red-500 font-bold hidden absolute -bottom-4 left-0">Preencha este campo</span>
                            <span id="error-otherCropInput" class="text-[9px] text-red-500 font-bold hidden absolute -bottom-4 left-0">Preencha este campo</span>
                        </div>

                        <div class="relative">
                            <label id="blockLabel" class="text-xs font-bold text-slate-500 uppercase mb-1 block">Nº Bloco/Talhão</label>
                            
                            <!-- Input e Select alternáveis -->
                            <input type="text" id="blockId" required oninput="clearError('blockId')" placeholder="Ex: 1 - A" class="w-full p-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none text-sm bg-white">
                            
                            <select id="blockSelect" onchange="clearError('blockSelect')" class="hidden w-full p-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none text-sm bg-white">
                                <option value="">Selecione...</option>
                            </select>

                            <span id="error-blockId" class="text-[9px] text-red-500 font-bold hidden absolute -bottom-4 left-0">Preencha este campo</span>
                            <span id="error-blockSelect" class="text-[9px] text-red-500 font-bold hidden absolute -bottom-4 left-0">Selecione uma opção</span>
                        </div>
                    </div>

                    <!-- ALVO BIOLÓGICO -->
                    <div class="mb-5 relative">
                        <label class="text-xs font-bold text-slate-500 uppercase mb-1 block">Alvo Biológico (Praga/Doença)</label>
                        
                        <!-- SELECT ALVO -->
                        <select id="targetPestSelect" onchange="toggleOtherTargetPestInput(); clearError('targetPestSelect');" class="w-full p-2 border border-slate-300 rounded-lg text-sm bg-white focus:ring-2 focus:ring-blue-500 outline-none">
                            <option value="">Selecione...</option>
                            <!-- Opções preenchidas via JS -->
                        </select>

                        <!-- INPUT ALVO (OVERLAY) -->
                        <div id="targetPest-custom-div" class="hidden relative w-full fade-in">
                            <input type="text" id="targetPestInput" oninput="clearError('targetPestInput')" class="w-full p-2 pr-8 border border-slate-300 rounded-lg text-sm bg-white focus:ring-2 focus:ring-blue-500 outline-none" placeholder="Ex: Traça, Míldio...">
                            <button type="button" onclick="resetTargetPestField()" class="absolute right-2 top-1/2 -translate-y-1/2 text-slate-400 hover:text-red-500">
                                <i data-lucide="x-circle" width="14"></i>
                            </button>
                        </div>

                        <span id="error-targetPestSelect" class="text-[9px] text-red-500 font-bold hidden absolute -bottom-4 left-0">Selecione uma opção</span>
                        <span id="error-targetPestInput" class="text-[9px] text-red-500 font-bold hidden absolute -bottom-4 left-0">Preencha este campo</span>
                    </div>

                    <!-- LISTA DE PRODUTOS DINÂMICA -->
                    <div class="bg-slate-50 p-3 rounded-lg border border-slate-100">
                        <label class="text-[10px] font-bold text-blue-600 uppercase tracking-wide mb-2 flex justify-between items-center">
                            <span>Produtos & Dosagens</span>
                            <button type="button" onclick="addProductRow()" class="text-blue-500 hover:text-blue-700 flex items-center gap-1 text-[9px] bg-blue-50 px-2 py-1 rounded border border-blue-200 shadow-sm transition-all active:scale-95">
                                <i data-lucide="plus" width="10"></i> Add Produto
                            </button>
                        </label>
                        
                        <div id="productsContainer" class="space-y-2">
                            <!-- JS vai injetar linhas aqui -->
                        </div>
                    </div>

                    <!-- DADOS DA CALDA (VOLUME E PH) -->
                    <div class="grid grid-cols-2 gap-3">
                         <div class="col-span-1 relative">
                            <label class="text-[10px] font-bold text-blue-600 mb-1 block">Vol. Calda (L)</label>
                            <input type="number" id="syrupVolume" required oninput="clearError('syrupVolume')" placeholder="200" class="w-full p-2 border border-blue-200 bg-blue-50 rounded-lg text-sm text-blue-800 font-bold focus:outline-none focus:ring-2 focus:ring-blue-500">
                            <span id="error-syrupVolume" class="text-[9px] text-red-500 font-bold hidden absolute -bottom-4 left-0">Preencha este campo</span>
                        </div>
                         <div class="col-span-1">
                            <label class="text-[10px] font-bold text-purple-600 mb-1 block">P.H.</label>
                            <input type="text" id="phValue" placeholder="Ex: 6.0" inputmode="decimal" class="w-full p-2 border border-purple-200 bg-purple-50 rounded-lg text-sm text-purple-800 font-bold focus:outline-none focus:ring-2 focus:ring-purple-500">
                        </div>
                    </div>
                    
                    <div class="mt-2">
                        <label class="text-[10px] font-bold text-slate-500 mb-1 block">Observações (Opcional)</label>
                        <input type="text" id="notes" placeholder="Ex: Vento calmo..." class="w-full p-2 border border-slate-300 rounded-lg text-sm bg-white focus:ring-2 focus:ring-blue-500 outline-none">
                   </div>

                    <button type="submit" id="submitBtn" class="w-full bg-slate-800 hover:bg-slate-900 text-white font-bold py-3 rounded-xl transition-all flex justify-center items-center gap-2 mt-4 active:scale-95">
                        <i data-lucide="plus-circle" class="w-4 h-4"></i> <span>Registrar Aplicação</span>
                    </button>
                </form>
            </div>

            <!-- Lista de Itens -->
            <div class="bg-white p-6 rounded-2xl shadow-sm border border-slate-200">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-sm font-bold text-slate-700">Aplicações Registradas</h3>
                    <!-- BOTÃO LIMPAR TUDO AGORA CHAMA O MODAL -->
                    <button onclick="showClearAllModal()" class="text-xs text-red-500 hover:text-red-700 font-bold underline">Limpar Tudo</button>
                </div>
                <ul id="itemsList" class="space-y-2 text-sm text-slate-600">
                    <!-- JS -->
                </ul>
            </div>
        </div>

        <!-- PREVIEW -->
        <div class="w-full lg:w-3/5 flex flex-col bg-slate-200/50 p-4 rounded-3xl border border-slate-300/50 min-h-[calc(100vh-6rem)]">
            
            <div id="report-card" class="w-full flex-1 flex flex-col bg-white shadow-2xl overflow-hidden border border-slate-100 relative">
                
                <!-- Cabeçalho (Cinza/Slate) -->
                <div class="bg-gradient-to-br from-slate-700 to-slate-900 p-6 text-white relative overflow-hidden flex flex-col justify-start shrink-0 gap-3 antialiased">
                    <img src="https://i.imgur.com/f7UnnL0.png" alt="Logo SPG" class="absolute top-4 right-4 w-24 h-24 z-0" style="image-rendering: -webkit-optimize-contrast;">
                    <div class="relative z-10 w-full pr-24"> 
                        <h2 id="reportTitle" class="text-sm font-bold leading-snug tracking-normal">
                            <!-- Injetado via JS -->
                        </h2>
                        <div class="mt-3 pt-3 border-t border-white/20">
                             <span id="headerDateTime" class="text-xs font-medium text-slate-300 block opacity-90 tracking-wide">
                                <!-- Injetado via JS -->
                            </span>
                        </div>
                    </div>
                </div>
                
                <!-- Painel de DADOS OPERACIONAIS -->
                <div id="operationalSummary" class="hidden bg-slate-50 border-b border-slate-200 p-4">
                    <!-- Preenchido via JS -->
                </div>

                <!-- Painel de Totais -->
                <div id="operationalFooter" class="bg-white border-b border-slate-200 p-4 shrink-0">
                     <!-- Conteúdo injetado via JS -->
                </div>

                <!-- Conteúdo -->
                <div id="reportContent" class="divide-y divide-slate-50 flex-1 overflow-y-auto">
                    <div class="p-8 text-center text-slate-400 text-xs italic leading-relaxed h-full flex items-center justify-center">Utilize o formulário para registrar as aplicações.</div>
                </div>

                <!-- Rodapé da Marca -->
                <div class="bg-slate-100 p-3 text-center border-t border-slate-200 shrink-0">
                    <div class="flex justify-center items-center gap-2 text-[10px] text-slate-400 font-medium uppercase tracking-widest leading-relaxed">
                        SPG • Controle Fitossanitário
                    </div>
                </div>

            </div>
        </div>
    </div>

    <!-- ELEMENTO OCULTO PARA O RELATÓRIO TÉCNICO PDF -->
    <div id="technical-report-template">
        <!-- Mantido igual ao anterior -->
        <div class="tech-header">
            <div>
                <h1 style="font-size: 24px; font-weight: bold; color: #1e293b; margin: 0;">RELATÓRIO DE APLICAÇÃO</h1>
                <p style="font-size: 14px; color: #64748b; margin: 5px 0 0 0;">Controle Fitossanitário • SPG</p>
            </div>
            <img src="https://i.imgur.com/f7UnnL0.png" style="height: 80px; width: auto;">
        </div>

        <div style="display: flex; justify-content: space-between; margin-bottom: 20px; font-size: 12px; border: 1px solid #e2e8f0; padding: 15px; background-color: #f8fafc;">
            <div style="line-height: 1.8;">
                <div><strong>Local:</strong> <span id="pdf-partner"></span></div>
                <div><strong>Data:</strong> <span id="pdf-date"></span> <span id="pdf-week"></span></div>
            </div>
            <div style="line-height: 1.8;">
                <div><strong>Solicitante:</strong> <span id="pdf-requestor"></span></div>
                <div><strong>Aplicador:</strong> <span id="pdf-applicator"></span></div>
            </div>
            <div style="line-height: 1.8; text-align: right;">
                <div><strong>Horário:</strong> <span id="pdf-time"></span></div>
                <div><strong>TOTAL DE APLICAÇÕES:</strong> <span id="pdf-total-blocks"></span></div>
            </div>
        </div>

        <h3 style="font-size: 14px; font-weight: bold; color: #1e293b; border-bottom: 1px solid #cbd5e1; padding-bottom: 5px; margin-bottom: 10px;">DETALHAMENTO DAS APLICAÇÕES</h3>
        
        <table class="tech-table">
            <thead>
                <tr>
                    <th style="width: 15%;">Setor/Bloco</th>
                    <th style="width: 15%;">Cultura</th>
                    <th style="width: 10%;">Alvo</th>
                    <th style="width: 30%;">Produtos (Dose)</th>
                    <!-- Ajustado tamanho da fonte para Calda (L) -->
                    <th style="width: 10%; font-size: 10px;">Calda (L)</th>
                    <!-- Alterado de pH para P.H -->
                    <th style="width: 5%;">P.H</th>
                    <th style="width: 15%;">Obs</th>
                </tr>
            </thead>
            <tbody id="pdf-table-body">
                <!-- Linhas injetadas via JS -->
            </tbody>
        </table>

        <div style="margin-top: 60px; display: flex; justify-content: space-between; page-break-inside: avoid;">
            <div style="width: 40%; border-top: 1px solid #333; text-align: center; font-size: 11px; padding-top: 5px;">
                Responsável Técnico
            </div>
            <div style="width: 40%; border-top: 1px solid #333; text-align: center; font-size: 11px; padding-top: 5px;">
                Responsável Aplicação
            </div>
        </div>
        
        <div style="position: absolute; bottom: 30px; width: 100%; text-align: center; font-size: 10px; color: #94a3b8; border-top: 1px solid #e2e8f0; padding-top: 10px;">
            Documento gerado eletronicamente pelo sistema SPG Fitossanitário.
        </div>
    </div>
    
    <!-- MODAL DE CONFIRMAÇÃO LIMPAR TUDO -->
    <div id="clearAllModal" class="fixed inset-0 bg-black/50 z-50 hidden flex justify-center items-center backdrop-blur-sm transition-opacity duration-300">
        <div class="bg-white rounded-xl shadow-2xl p-6 w-11/12 max-w-sm transform transition-all scale-100">
            <div class="text-center mb-5">
                <div class="mx-auto flex items-center justify-center h-12 w-12 rounded-full bg-red-100 mb-4">
                    <i data-lucide="alert-triangle" class="h-6 w-6 text-red-600"></i>
                </div>
                <h3 class="text-lg font-bold text-slate-800">Limpar Tudo?</h3>
                <p class="text-sm text-slate-500 mt-2">Tem certeza que deseja apagar todos os registros? Esta ação não pode ser desfeita.</p>
            </div>
            <div class="flex gap-3">
                <button onclick="hideClearAllModal()" class="flex-1 px-4 py-2 bg-slate-100 hover:bg-slate-200 text-slate-700 font-bold rounded-lg text-sm transition-colors">Cancelar</button>
                <button onclick="confirmClearAll()" class="flex-1 px-4 py-2 bg-red-600 hover:bg-red-700 text-white font-bold rounded-lg text-sm transition-colors">Sim, Limpar</button>
            </div>
        </div>
    </div>

    <!-- MODAL GENÉRICO DE MENSAGEM -->
    <div id="messageModal" class="fixed inset-0 bg-black/50 z-50 hidden flex justify-center items-center backdrop-blur-sm transition-opacity duration-300">
        <div class="bg-white rounded-xl shadow-2xl p-6 w-11/12 max-w-sm transform transition-all scale-100 text-center">
            <div id="msgIconContainer" class="mx-auto flex items-center justify-center h-12 w-12 rounded-full mb-4">
                <!-- Icon injetado via JS -->
            </div>
            <h3 id="msgTitle" class="text-lg font-bold text-slate-800"></h3>
            <p id="msgText" class="text-sm text-slate-500 mt-2 mb-4"></p>
            <button onclick="hideMessageModal()" class="w-full px-4 py-2 bg-slate-800 hover:bg-slate-900 text-white font-bold rounded-lg text-sm transition-colors">OK</button>
        </div>
    </div>

    <!-- JAVASCRIPT LOGIC -->
    <script>
        console.log("Aplicação 'Fitossanitário SPG' carregada.");

        let appData = [];
        let editingIndex = -1;
        let lastFormState = null; // Variável para guardar o estado antes da edição
        const STORAGE_KEY = 'spg_fitosanitario_data'; 
        const GLOBAL_KEY = 'spg_global_info'; 

        // Estado Global
        let globalInfo = {
            partner: '',
            date: '',
            requestor: '',
            applicator: '',
            startTime: '',
            endTime: '',
            duration: ''
        };

        // INICIALIZAÇÃO
        lucide.createIcons();
        // REMOVIDO: document.getElementById('appDate').valueAsDate = new Date();
        addProductRow();
        loadFromStorage();
        updateDynamicTitle();
        calculateDuration();
        updateGlobalState();
        handleCropChange(); // Garante o estado inicial correto

        // --- VALIDAÇÃO DE CAMPO ---
        function toggleError(id, show) {
            const el = document.getElementById(id);
            const err = document.getElementById('error-' + id);
            
            if (!el) return; 

            if(show) {
                el.classList.add('border-red-500', 'ring-1', 'ring-red-500');
                if(err) err.classList.remove('hidden');
            } else {
                el.classList.remove('border-red-500', 'ring-1', 'ring-red-500');
                if(err) err.classList.add('hidden');
            }
        }
        
        function clearError(id) {
            toggleError(id, false);
        }

        // --- VALIDAÇÃO DE CABEÇALHO ---
        function validateHeader() {
            let isValid = true;
            
            // Helper to check standard vs custom input
            const checkField = (selectId, customInputId) => {
                const select = document.getElementById(selectId);
                const customInput = document.getElementById(customInputId);
                
                if (select.classList.contains('hidden') || select.value === 'Outro') {
                     if (!customInput.value.trim()) {
                         toggleError(customInputId, true);
                         return false;
                     } else {
                         toggleError(customInputId, false);
                         return true;
                     }
                } else {
                    if (!select.value) {
                        toggleError(selectId, true);
                        return false;
                    } else {
                        toggleError(selectId, false);
                        return true;
                    }
                }
            };

            // 1. Local
            if(!document.getElementById('partner').value) { 
                toggleError('partner', true); 
                isValid = false; 
            } else { 
                toggleError('partner', false); 
            }

            // 2. Data
            if(!document.getElementById('appDate').value) { 
                toggleError('appDate', true); 
                isValid = false; 
            } else { 
                toggleError('appDate', false); 
            }

            // 3. Solicitante
            if (!checkField('requestor', 'otherRequestorInput')) isValid = false;

            // 4. Aplicador
            if (!checkField('applicator', 'otherApplicatorInput')) isValid = false;

            // 5. Início
            if(!document.getElementById('startTime').value) { 
                toggleError('startTime', true); 
                isValid = false; 
            } else { 
                toggleError('startTime', false); 
            }

            // 6. Fim
            if(!document.getElementById('endTime').value) { 
                toggleError('endTime', true); 
                isValid = false; 
            } else { 
                toggleError('endTime', false); 
            }

            return isValid;
        }

        // --- ATUALIZAÇÃO EM TEMPO REAL (DADOS GERAIS) ---
        function updateGlobalState() {
            // Limpa erros visuais ao editar
            const fields = ['partner', 'appDate', 'requestor', 'otherRequestorInput', 'applicator', 'otherApplicatorInput', 'startTime', 'endTime'];
            fields.forEach(id => {
                const el = document.getElementById(id);
                // Reset manual simples:
                 if(el) el.classList.remove('border-red-500', 'ring-1', 'ring-red-500');
            });
            // Oculta spans de erro específicos
            document.querySelectorAll('[id^="error-"]').forEach(el => el.classList.add('hidden'));

            // Coleta dados dos campos globais
            globalInfo.partner = document.getElementById('partner').value;
            globalInfo.date = document.getElementById('appDate').value;
            
            // Solicitante
            const reqSelect = document.getElementById('requestor');
            if (!reqSelect.classList.contains('hidden')) {
                 globalInfo.requestor = reqSelect.value;
            } else {
                 globalInfo.requestor = document.getElementById('otherRequestorInput').value;
            }

            // Aplicador
            const appSelect = document.getElementById('applicator');
            if (!appSelect.classList.contains('hidden')) {
                globalInfo.applicator = appSelect.value;
            } else {
                globalInfo.applicator = document.getElementById('otherApplicatorInput').value;
            }

            globalInfo.startTime = document.getElementById('startTime').value;
            globalInfo.endTime = document.getElementById('endTime').value;
            globalInfo.duration = document.getElementById('totalDuration').value;

            localStorage.setItem(GLOBAL_KEY, JSON.stringify(globalInfo));
            updateDynamicTitle();
            renderHeaderAndSummary();
            
            // Re-render list to filter by new partner immediately
            renderList();
            renderReport();
        }

        // --- FUNÇÕES DE FORMATAÇÃO ---
        function formatDecimalInput(input) {
            let value = input.value;
            value = value.replace('.', ',');
            value = value.replace(/[^0-9,]/g, '');
            const parts = value.split(',');
            if (parts.length > 2) {
                value = parts[0] + ',' + parts.slice(1).join('');
            }
            input.value = value;
        }

        // --- LÓGICA DE PRODUTOS DINÂMICOS ---
        function addProductRow(name = '', dose = '', unit = 'ml', type = '') { 
            const container = document.getElementById('productsContainer');
            const rowId = 'prod-row-' + Date.now() + Math.random().toString(36).substr(2, 5);
            
            const div = document.createElement('div');
            div.className = "flex gap-2 items-start product-row animate-fade-in flex-wrap sm:flex-nowrap"; 
            div.id = rowId;
            
            // Options for select
            const units = ['ml', 'L', 'g', 'Kg'];
            const optionsHtml = units.map(u => `<option value="${u}" ${u === unit ? 'selected' : ''}>${u}</option>`).join('');

            // Tipos de Produto - ORDENADOS A-Z
            const standardTypes = [
                'Acaricidas', 'Adjuvantes', 'Bactericidas', 'Biológico', 'Desfolhantes',
                'Espalhante', 'Estabilizador de PH', 'Fungicidas', 'Herbicidas', 'Inseticidas',
                'Natural', 'Nematicidas', 'Nutricional', 'Repelente', 'Rodenticidas'
            ];

            // List of Products SORTED ALPHABETICALLY
            const standardProducts = [
                "Acadian", "Ácido Peracético", "Alexia", "Alliado", "Avatar", "Azospirilium", "Beauveria", "Bioimpeto", "Boro",
                "Carbon N-10", "CalPlant", "Coda Sul PH", "Crystal-BT", "Detergente", "Dipel", "Durivo", "Eleito", "Evidence", "Ferro", "Full Grow", 
                "Facility", "Joiner", "Karate", "Kasumin", "Lannate", "Mancozeb", "Manipueira", "MAP (Monoamônio Fosfato)", "Master Mix", "Metarhizium", 
                "MKP (Monofosfato de Potássio)", "Molibdato", "Mukussan", "Nitrato de Cálcio", "Nitrato de Potássio", "Octaborato", 
                "Óleo Vegetal", "Shenzi", "Sanmite", "Speed Dil", "Sulfato de Magnésio", "Sulfato de Potássio", "Timorex", "Trichoderma", 
                "Trichodermil", "Vinagre", "Vertimec","Xixi", "YaraVita - Biotrac", "YaraVita - Bortrac", "YaraVita - Caltrac", 
                "YaraVita - Gotamax", "YaraVita - Zintrac", "Ziel"
            ];
            
            // Determine initial state for TYPE
            let isCustom = false;
            let displayType = type;
            let customTypeValue = '';

            if (type && !standardTypes.includes(type) && type !== 'Outros') {
                isCustom = true;
                customTypeValue = type;
                displayType = 'Outros';
            } else if (type === 'Outros') {
                 isCustom = true;
                 displayType = 'Outros';
            }

            const typesOptionsHtml = [...standardTypes, 'Outros'].map(t => 
                `<option value="${t}" ${t === displayType ? 'selected' : ''}>${t}</option>`
            ).join('');

            // Determine initial state for PRODUCT NAME
            let isCustomProduct = false;
            let displayProduct = name;
            let customProductValue = '';

            if (name && !standardProducts.includes(name)) {
                isCustomProduct = true;
                customProductValue = name;
                displayProduct = 'Outros';
            } 
            
            const productsOptionsHtml = [...standardProducts, 'Outros'].map(p => 
                `<option value="${p}" ${p === displayProduct ? 'selected' : ''}>${p}</option>`
            ).join('');
            
            // Classes e Atributos para TIPO
            const selectClass = isCustom ? "prod-type-select hidden w-full p-2 border border-slate-300 rounded-lg text-sm bg-white focus:ring-2 focus:ring-blue-500 outline-none" : `prod-type-select w-full p-2 border border-slate-300 rounded-lg text-sm bg-white focus:ring-2 focus:ring-blue-500 outline-none ${!type ? 'text-slate-400' : 'text-slate-800'}`;
            const customInputDivClass = isCustom ? "prod-type-custom-div w-full relative" : "prod-type-custom-div hidden w-full relative";
            const selectRequired = !isCustom ? 'required' : '';
            const inputRequired = isCustom ? 'required' : '';

            // Classes e Atributos para PRODUTO
            const prodSelectClass = isCustomProduct ? "prod-name-select hidden w-full p-2 border border-slate-300 rounded-lg text-sm bg-white focus:ring-2 focus:ring-blue-500 outline-none" : `prod-name-select w-full p-2 border border-slate-300 rounded-lg text-sm bg-white focus:ring-2 focus:ring-blue-500 outline-none ${!name ? 'text-slate-400' : 'text-slate-800'}`;
            const prodCustomInputDivClass = isCustomProduct ? "prod-name-custom-div w-full relative" : "prod-name-custom-div hidden w-full relative";
            const prodSelectRequired = !isCustomProduct ? 'required' : '';
            const prodInputRequired = isCustomProduct ? 'required' : '';

            div.innerHTML = `
                <div class="w-full sm:w-auto sm:flex-grow relative">
                    <!-- PRODUCT SELECT -->
                    <select onchange="this.classList.remove('text-slate-400'); this.classList.add('text-slate-800'); this.classList.remove('border-red-500'); toggleRowCustomProduct(this)" class="${prodSelectClass}" ${prodSelectRequired}>
                        <option value="" disabled ${!name ? 'selected' : ''}>Selecione o Produto...</option>
                        ${productsOptionsHtml}
                    </select>

                    <!-- PRODUCT INPUT OVERLAY -->
                    <div class="${prodCustomInputDivClass}">
                        <input type="text" placeholder="Nome do Produto" oninput="this.classList.remove('border-red-500')" class="prod-name-custom-input w-full p-2 pr-6 border border-slate-300 rounded-lg text-sm bg-white focus:ring-2 focus:ring-blue-500 outline-none fade-in" value="${customProductValue}" ${prodInputRequired}>
                        <button type="button" onclick="resetRowProduct(this)" class="absolute right-1 top-1/2 -translate-y-1/2 text-slate-400 hover:text-red-500 p-1">
                            <i data-lucide="x-circle" width="14"></i>
                        </button>
                    </div>
                </div>
                <div class="w-1/2 sm:w-28 relative">
                     <!-- TYPE SELECT -->
                     <select onchange="this.classList.remove('text-slate-400'); this.classList.add('text-slate-800'); this.classList.remove('border-red-500'); toggleRowCustomType(this)" class="${selectClass}" ${selectRequired}>
                        <option value="" disabled ${!type ? 'selected' : ''}>Selecione...</option>
                        ${typesOptionsHtml}
                    </select>

                    <!-- TYPE INPUT OVERLAY -->
                    <div class="${customInputDivClass}">
                        <input type="text" placeholder="Qual?" oninput="this.classList.remove('border-red-500')" class="prod-type-custom-input w-full p-2 pr-6 border border-slate-300 rounded-lg text-sm bg-white focus:ring-2 focus:ring-blue-500 outline-none fade-in" value="${customTypeValue}" ${inputRequired}>
                        <button type="button" onclick="resetRowType(this)" class="absolute right-1 top-1/2 -translate-y-1/2 text-slate-400 hover:text-red-500 p-1">
                            <i data-lucide="x-circle" width="14"></i>
                        </button>
                    </div>
                </div>
                <div class="w-1/4 sm:w-20">
                    <input type="text" inputmode="decimal" oninput="formatDecimalInput(this); this.classList.remove('border-red-500')" placeholder="Dose" class="prod-dose-input w-full p-2 border border-slate-300 rounded-lg text-sm bg-white focus:ring-2 focus:ring-blue-500 outline-none" value="${dose}" required>
                </div>
                <div class="w-1/4 sm:w-20">
                    <select class="prod-unit-input w-full p-2 border border-slate-300 rounded-lg text-sm bg-white focus:ring-2 focus:ring-blue-500 outline-none">
                        ${optionsHtml}
                    </select>
                </div>
                <button type="button" onclick="removeProductRow('${rowId}')" class="text-red-400 hover:text-red-600 hover:bg-red-50 p-2 rounded-lg transition-colors h-[38px] flex items-center justify-center" tabindex="-1">
                    <i data-lucide="trash-2" width="16"></i>
                </button>
            `;
            container.appendChild(div);
            lucide.createIcons();
        }

        // --- NEW PRODUCT TOGGLE FUNCTIONS (COM LÓGICA DE REQUIRED) ---
        function toggleRowCustomProduct(selectElement) {
            if(selectElement.value === 'Outros') {
                const parent = selectElement.parentElement;
                const customDiv = parent.querySelector('.prod-name-custom-div');
                const customInput = customDiv.querySelector('input');
                
                selectElement.classList.add('hidden');
                selectElement.required = false; 

                customDiv.classList.remove('hidden');
                customInput.required = true; 
                customInput.focus();
            }
        }

        function resetRowProduct(btnElement) {
            const customDiv = btnElement.parentElement;
            const parent = customDiv.parentElement;
            const select = parent.querySelector('.prod-name-select');
            const input = customDiv.querySelector('input');
            
            input.value = ''; 
            input.required = false; 
            
            select.selectedIndex = 0; 
            select.classList.remove('hidden');
            select.classList.add('text-slate-400'); 
            select.required = true; 

            customDiv.classList.add('hidden');
        }

        function toggleRowCustomType(selectElement) {
            if(selectElement.value === 'Outros') {
                const parent = selectElement.parentElement;
                const customDiv = parent.querySelector('.prod-type-custom-div');
                const customInput = customDiv.querySelector('input');
                
                selectElement.classList.add('hidden');
                selectElement.required = false;

                customDiv.classList.remove('hidden');
                customInput.required = true;
                customInput.focus();
            }
        }

        function resetRowType(btnElement) {
            const customDiv = btnElement.parentElement;
            const parent = customDiv.parentElement;
            const select = parent.querySelector('.prod-type-select');
            const input = customDiv.querySelector('input');
            
            input.value = ''; 
            input.required = false;

            select.value = ''; 
            select.selectedIndex = 0; 
            select.classList.remove('hidden');
            select.classList.add('text-slate-400');
            select.required = true;

            customDiv.classList.add('hidden');
        }

        function removeProductRow(id) {
            const container = document.getElementById('productsContainer');
            if (container.children.length > 1) {
                document.getElementById(id).remove();
            } else {
                const row = document.getElementById(id);
                const prodResetBtn = row.querySelector('button[onclick^="resetRowProduct"]');
                if(prodResetBtn) resetRowProduct(prodResetBtn);
                const typeResetBtn = row.querySelector('button[onclick^="resetRowType"]');
                if(typeResetBtn) resetRowType(typeResetBtn);
                row.querySelector('.prod-dose-input').value = '';
            }
        }

        function getProductsFromForm() {
            const rows = document.querySelectorAll('.product-row');
            const products = [];
            rows.forEach(row => {
                const prodSelect = row.querySelector('.prod-name-select');
                let name = prodSelect.value;
                if (prodSelect.classList.contains('hidden')) {
                    name = row.querySelector('.prod-name-custom-input').value.trim();
                }

                const select = row.querySelector('.prod-type-select');
                let type = select.value;
                if (select.classList.contains('hidden')) {
                    type = row.querySelector('.prod-type-custom-input').value.trim();
                }

                const dose = row.querySelector('.prod-dose-input').value.trim();
                const unit = row.querySelector('.prod-unit-input').value;
                
                if (name && dose) {
                    products.push({ name, type, dose, unit });
                }
            });
            return products;
        }

        // --- NOVA FUNÇÃO: Captura estado bruto dos produtos (mesmo incompletos) ---
        function getRawProductsState() {
            const rows = document.querySelectorAll('.product-row');
            return Array.from(rows).map(row => {
                const prodSelect = row.querySelector('.prod-name-select');
                const prodCustom = row.querySelector('.prod-name-custom-input');
                const typeSelect = row.querySelector('.prod-type-select');
                const typeCustom = row.querySelector('.prod-type-custom-input');
                
                let name = prodSelect.value;
                if (prodSelect.classList.contains('hidden')) name = prodCustom.value; // Pega valor bruto
                
                let type = typeSelect.value;
                if (typeSelect.classList.contains('hidden')) type = typeCustom.value;

                return {
                    name: name,
                    type: type,
                    dose: row.querySelector('.prod-dose-input').value,
                    unit: row.querySelector('.prod-unit-input').value
                };
            });
        }

        // --- NOVA FUNÇÃO: Captura estado completo do formulário ---
        function getFormStateObject() {
            // Determina cultura efetiva
            const cropSel = document.getElementById('crop');
            const cropInp = document.getElementById('otherCropInput');
            let crop = cropSel.value;
            if (cropSel.classList.contains('hidden')) crop = cropInp.value;

            // Determina bloco efetivo
            const blockInp = document.getElementById('blockId');
            const blockSel = document.getElementById('blockSelect');
            let block = blockInp.value;
            if (!blockSel.classList.contains('hidden')) block = blockSel.value;
            
            // Determina alvo efetivo
            const targetSel = document.getElementById('targetPestSelect');
            const targetInp = document.getElementById('targetPestInput');
            let target = targetSel.value;
            if (targetSel.classList.contains('hidden')) target = targetInp.value;

            // Determina solicitante e aplicador efetivos
            const reqSel = document.getElementById('requestor');
            const reqInp = document.getElementById('otherRequestorInput');
            let req = reqSel.value;
            if (reqSel.classList.contains('hidden') || req === 'Outro') req = reqInp.value;

            const appSel = document.getElementById('applicator');
            const appInp = document.getElementById('otherApplicatorInput');
            let app = appSel.value;
            if (appSel.classList.contains('hidden') || app === 'Outro') app = appInp.value;

            return {
                // Globais
                partner: document.getElementById('partner').value,
                date: document.getElementById('appDate').value,
                requestor: req,
                applicator: app,
                startTime: document.getElementById('startTime').value,
                endTime: document.getElementById('endTime').value,
                duration: document.getElementById('totalDuration').value,
                
                // Bloco
                crop: crop,
                block: block,
                target: target,
                products: getRawProductsState(),
                volume: document.getElementById('syrupVolume').value,
                ph: document.getElementById('phValue').value,
                notes: document.getElementById('notes').value
            };
        }

        // --- NOVA FUNÇÃO: Preenche o formulário com um objeto de dados (usado para editar e restaurar) ---
        function populateForm(item) {
            // 1. DADOS GERAIS
            document.getElementById('partner').value = item.partner || '';
            document.getElementById('appDate').value = item.date || '';

            // Solicitante
            const reqSelect = document.getElementById('requestor');
            const reqOptions = Array.from(reqSelect.options).map(o => o.value);
            // Reset visual
            reqSelect.classList.remove('hidden');
            document.getElementById('requestor-custom-div').classList.add('hidden');
            
            if (reqOptions.includes(item.requestor) && item.requestor !== 'Outro') {
                reqSelect.value = item.requestor;
            } else {
                reqSelect.value = 'Outro';
                toggleOtherRequestorInput();
                document.getElementById('otherRequestorInput').value = item.requestor || '';
            }

            // Aplicador
            const appSelect = document.getElementById('applicator');
            const appOptions = Array.from(appSelect.options).map(o => o.value);
            // Reset visual
            appSelect.classList.remove('hidden');
            document.getElementById('applicator-custom-div').classList.add('hidden');

            if (appOptions.includes(item.applicator) && item.applicator !== 'Outro') {
                appSelect.value = item.applicator;
            } else {
                appSelect.value = 'Outro';
                toggleOtherApplicatorInput();
                document.getElementById('otherApplicatorInput').value = item.applicator || '';
            }

            document.getElementById('startTime').value = item.startTime || '';
            document.getElementById('endTime').value = item.endTime || '';
            calculateDuration(); 
            updateGlobalState();

            // 2. CULTURA
            const cropSelect = document.getElementById('crop');
            const otherInput = document.getElementById('otherCropInput');
            const cropOptions = Array.from(cropSelect.options).map(o => o.value);
            
            // Reset visual
            const cropCustomDiv = document.getElementById('crop-custom-div');
            cropSelect.classList.remove('hidden');
            cropCustomDiv.classList.add('hidden');
            
            if (cropOptions.includes(item.crop) && item.crop !== 'Outros') {
                cropSelect.value = item.crop;
            } else {
                cropSelect.value = 'Outros';
                toggleOtherCropInput();
                otherInput.value = item.crop || ''; 
            }
            
            handleCropChange(); // Atualiza visibilidade de bloco e lista de pragas

            // 3. BLOCO
            const blockSelect = document.getElementById('blockSelect');
            const blockInput = document.getElementById('blockId');
            if (blockSelect && !blockSelect.classList.contains('hidden')) {
                blockSelect.value = item.block || '';
            } else {
                blockInput.value = item.block || '';
            }

            // 4. ALVO BIOLÓGICO
            const targetSelect = document.getElementById('targetPestSelect');
            const targetInput = document.getElementById('targetPestInput');
            const targetOptions = Array.from(targetSelect.options).map(o => o.value);
            
            resetTargetPestField(); // Reset visual

            if (targetOptions.includes(item.target) && item.target !== 'Outros') {
                targetSelect.value = item.target || '';
            } else {
                targetSelect.value = 'Outros';
                toggleOtherTargetPestInput(); 
                targetInput.value = item.target || ''; 
            }

            // 5. PRODUTOS
            const container = document.getElementById('productsContainer');
            container.innerHTML = '';
            if (item.products && item.products.length > 0) {
                item.products.forEach(p => addProductRow(p.name, p.dose, p.unit, p.type));
            } else {
                addProductRow(item.product, item.dosage, 'ml', 'Biológico');
            }

            // 6. OUTROS
            document.getElementById('syrupVolume').value = item.volume || '';
            document.getElementById('phValue').value = item.ph || '';
            document.getElementById('notes').value = item.notes || '';
            
            lucide.createIcons();
        }

        // --- CÁLCULO DE TEMPO ---
        function calculateDuration() {
            const start = document.getElementById('startTime').value;
            const end = document.getElementById('endTime').value;
            const totalInput = document.getElementById('totalDuration');
            if (start && end) {
                const startD = new Date(`2000-01-01T${start}`);
                const endD = new Date(`2000-01-01T${end}`);
                let diffMs = endD - startD;
                if (diffMs < 0) diffMs += 24 * 60 * 60 * 1000;
                const totalMinutes = Math.floor(diffMs / 60000);
                const hours = Math.floor(totalMinutes / 60);
                const minutes = totalMinutes % 60;
                let durationStr = "";
                if (hours > 0) durationStr += `${hours}h `;
                durationStr += `${minutes}min`;
                totalInput.value = durationStr;
            } else {
                totalInput.value = "";
            }
            updateGlobalState();
        }

        // --- FUNÇÃO PARA GERENCIAR CULTURA E BLOCO/SETOR ---
        function handleCropChange() {
            const select = document.getElementById('crop');
            const otherInput = document.getElementById('otherCropInput');
            
            const blockLabel = document.getElementById('blockLabel');
            const blockInput = document.getElementById('blockId');
            const blockSelect = document.getElementById('blockSelect'); 

            // ALVO BIOLÓGICO ELEMENTS
            const targetSelect = document.getElementById('targetPestSelect');
            
            // LISTAS DE PRAGAS/DOENÇAS
            const pestsBrassicas = [
                "Adubação Foliar", "Alternaria", "Bacteriose", "Hérnia", "Lagarta", "Míldio", 
                "Podridão Negra", "Pulgão", "Traça", "Tripes", "Vaquinha"
            ];
            
            const pestsCucumber = [
                "Ácaro", "Adubação Foliar", "Alternaria", "Antracnose", "Bacteriose", "Lagarta", 
                "Mancha Angular", "Míldio", "Mosca Branca", "Oídio", "Pulgão", 
                "Tripes", "Vaquinha", "Vírus"
            ];

            const pestsGeneral = ["Adubação Foliar", "Ácaro", "Lagarta", "Fungo", "Bactéria", "Vírus"];

            // 1. Alternar input 'Outros' (Cultura)
            let cropValue = select.value;
            if (select.classList.contains('hidden')) {
                cropValue = 'Outros'; 
            }

            // 2. Lógica do Dropdown/Input de Bloco
            let useSelect = false;
            let options = [];
            let pestOptions = [];

            if (cropValue === 'Pepino') {
                blockLabel.innerText = 'Nº Setor';
                useSelect = true;
                options = ['1', '2', '3', '4'];
                // Ordena e adiciona Outros no final
                pestOptions = pestsCucumber.sort();
                pestOptions.push("Outros");
            } else if (cropValue === 'Brócolis' || cropValue === 'Couve-Flor') {
                blockLabel.innerText = 'Nº Bloco/Talhão';
                useSelect = true;
                
                // Gera 1-19
                for (let i = 1; i <= 19; i++) {
                    options.push(i.toString());
                }
                
                // Adiciona letras A, B, C, D, E
                options.push('A', 'B', 'C', 'D', 'E');
                // Ordena e adiciona Outros no final
                pestOptions = pestsBrassicas.sort();
                pestOptions.push("Outros");
            } else {
                // Outros
                blockLabel.innerText = 'Nº Bloco/Talhão';
                useSelect = false; // Use text input
                // Ordena e adiciona Outros no final
                pestOptions = pestsGeneral.sort();
                pestOptions.push("Outros");
            }

            // Atualiza Bloco
            if (useSelect) {
                blockInput.classList.add('hidden');
                blockInput.required = false;
                if(blockSelect) {
                    blockSelect.classList.remove('hidden');
                    blockSelect.required = true;
                    // Save current selection if valid
                    const currentVal = blockSelect.value;
                    blockSelect.innerHTML = '<option value="">Selecione...</option>';
                    options.forEach(opt => {
                        const el = document.createElement('option');
                        el.value = opt; el.innerText = opt;
                        if(opt === currentVal) el.selected = true;
                        blockSelect.appendChild(el);
                    });
                }
            } else {
                blockInput.classList.remove('hidden');
                blockInput.required = true;
                blockInput.placeholder = 'Ex: 1 - A';
                if(blockSelect) {
                    blockSelect.classList.add('hidden');
                    blockSelect.required = false;
                }
            }

            // Atualiza Alvo Biológico
            if(targetSelect) {
                const currentPest = targetSelect.value;
                const isCustomPestVisible = !document.getElementById('targetPest-custom-div').classList.contains('hidden');

                targetSelect.innerHTML = '<option value="">Selecione...</option>';
                // pestOptions já está ordenado e com Outros no final, removemos o .sort() daqui
                pestOptions.forEach(pest => {
                    const el = document.createElement('option');
                    el.value = pest;
                    el.innerText = pest;
                    if (!isCustomPestVisible && pest === currentPest) el.selected = true;
                    if (isCustomPestVisible && pest === 'Outros') el.selected = true; 
                    targetSelect.appendChild(el);
                });
            }
        }

        // --- LÓGICA DE ALVO BIOLÓGICO (NOVO) ---
        function toggleOtherTargetPestInput() {
            const select = document.getElementById('targetPestSelect');
            const customDiv = document.getElementById('targetPest-custom-div');
            const customInput = document.getElementById('targetPestInput');
            if (select.value === 'Outros') {
                select.classList.add('hidden');
                customDiv.classList.remove('hidden');
                customInput.focus();
            }
        }

        function resetTargetPestField() {
            const select = document.getElementById('targetPestSelect');
            const customDiv = document.getElementById('targetPest-custom-div');
            const customInput = document.getElementById('targetPestInput');
            customInput.value = '';
            select.selectedIndex = 0; 
            select.classList.remove('hidden');
            customDiv.classList.add('hidden');
        }

        // --- LÓGICA DE INPUTS "OUTRO" (SOLICITANTE/APLICADOR) ---
        function toggleOtherRequestorInput() {
            const select = document.getElementById('requestor');
            const customDiv = document.getElementById('requestor-custom-div');
            const customInput = document.getElementById('otherRequestorInput');
            if (select.value === 'Outro') {
                select.classList.add('hidden');
                customDiv.classList.remove('hidden');
                customInput.focus();
            }
        }
        function resetRequestorField() {
            const select = document.getElementById('requestor');
            const customDiv = document.getElementById('requestor-custom-div');
            const customInput = document.getElementById('otherRequestorInput');
            customInput.value = '';
            select.value = 'José Márcio'; 
            select.selectedIndex = 0; 
            select.classList.remove('hidden');
            customDiv.classList.add('hidden');
        }
        function toggleOtherApplicatorInput() {
            const select = document.getElementById('applicator');
            const customDiv = document.getElementById('applicator-custom-div');
            const customInput = document.getElementById('otherApplicatorInput');
            if (select.value === 'Outro') {
                select.classList.add('hidden');
                customDiv.classList.remove('hidden');
                customInput.focus();
            }
        }
        function resetApplicatorField() {
            const select = document.getElementById('applicator');
            const customDiv = document.getElementById('applicator-custom-div');
            const customInput = document.getElementById('otherApplicatorInput');
            customInput.value = '';
            select.selectedIndex = 0; 
            select.classList.remove('hidden');
            customDiv.classList.add('hidden');
        }
        
        function toggleOtherCropInput() {
            const select = document.getElementById('crop');
            const customDiv = document.getElementById('crop-custom-div');
            const customInput = document.getElementById('otherCropInput');
            
            if (select.value === 'Outros') {
                select.classList.add('hidden');
                customDiv.classList.remove('hidden');
                customInput.focus();
            }
        }
        function resetCropField() {
            const select = document.getElementById('crop');
            const customDiv = document.getElementById('crop-custom-div');
            const customInput = document.getElementById('otherCropInput');
            customInput.value = '';
            select.value = 'Brócolis';
            select.selectedIndex = 0;
            select.classList.remove('hidden');
            customDiv.classList.add('hidden');
        }

        // --- PERSISTÊNCIA ---
        function saveToStorage() {
            try { localStorage.setItem(STORAGE_KEY, JSON.stringify(appData)); } catch (e) { console.error("Erro ao salvar", e); }
        }

        function loadFromStorage() {
            try {
                const storedGlobal = localStorage.getItem(GLOBAL_KEY);
                if (storedGlobal) {
                    globalInfo = JSON.parse(storedGlobal);
                    if(globalInfo.partner) document.getElementById('partner').value = globalInfo.partner;
                    if(globalInfo.date) document.getElementById('appDate').value = globalInfo.date;
                    
                    const reqSelect = document.getElementById('requestor');
                    const reqOptions = Array.from(reqSelect.options).map(o => o.value);
                    if (globalInfo.requestor && reqOptions.includes(globalInfo.requestor)) {
                        reqSelect.value = globalInfo.requestor;
                    } else if (globalInfo.requestor) {
                        reqSelect.value = 'Outro';
                        toggleOtherRequestorInput();
                        document.getElementById('otherRequestorInput').value = globalInfo.requestor;
                    }

                    const appSelect = document.getElementById('applicator');
                    const appOptions = Array.from(appSelect.options).map(o => o.value);
                    if (globalInfo.applicator && appOptions.includes(globalInfo.applicator)) {
                        appSelect.value = globalInfo.applicator;
                    } else if (globalInfo.applicator) {
                        appSelect.value = 'Outro';
                        toggleOtherApplicatorInput();
                        document.getElementById('otherApplicatorInput').value = globalInfo.applicator;
                    }

                    if(globalInfo.startTime) document.getElementById('startTime').value = globalInfo.startTime;
                    if(globalInfo.endTime) document.getElementById('endTime').value = globalInfo.endTime;
                    if(globalInfo.duration) document.getElementById('totalDuration').value = globalInfo.duration;
                }

                const storedData = localStorage.getItem(STORAGE_KEY);
                if (storedData) {
                    appData = JSON.parse(storedData);
                    appData.forEach(item => {
                        if (item.product && (!item.products || item.products.length === 0)) {
                            item.products = [{ name: item.product, dose: item.dosage, unit: 'ml', type: 'Biológico' }]; 
                        }
                    });
                    renderList();
                }
                renderHeaderAndSummary();
                updateDynamicTitle();
                renderReport(); 

            } catch (e) { console.error("Erro ao carregar", e); }
        }
        
        function getFilteredData() {
            const currentPartner = globalInfo.partner || document.getElementById('partner').value; 
            if(!currentPartner) return [];
            return appData.filter(item => item.partner === currentPartner);
        }

        function getWeekNumber(d) {
            d = new Date(Date.UTC(d.getFullYear(), d.getMonth(), d.getDate()));
            d.setUTCDate(d.getUTCDate() + 4 - (d.getUTCDay() || 7));
            var yearStart = new Date(Date.UTC(d.getUTCFullYear(), 0, 1));
            return Math.ceil((((d - yearStart) / 86400000) + 1) / 7);
        }

        function updateDynamicTitle() {
            const displayPartner = globalInfo.partner || 'Parceiro';
            const titleHTML = `Resumo de Aplicações Fitossanitárias<br>${displayPartner}`;
            document.getElementById('reportTitle').innerHTML = titleHTML;

            const dateElement = document.getElementById('headerDateTime');
            if (globalInfo.date) {
                const parts = globalInfo.date.split('-');
                const day = parts[2];
                const month = parts[1];
                const year = parts[0];
                const dateForWeek = new Date(year, month - 1, day);
                const weekNumber = getWeekNumber(dateForWeek);
                dateElement.innerText = `Aplicações: ${day}/${month}/${year} - Semana ${weekNumber}`;
                dateElement.style.opacity = "1";
            } else {
                dateElement.innerText = "Aplicações:";
            }
        }

        // MODAL FUNCTIONS
        function showClearAllModal() {
            document.getElementById('clearAllModal').classList.remove('hidden');
        }

        function hideClearAllModal() {
            document.getElementById('clearAllModal').classList.add('hidden');
        }

        function confirmClearAll() {
            appData = [];
            saveToStorage();
            clearBlockForm(false); 
            renderReport();
            renderList();
            hideClearAllModal();
        }

        // --- MENSAGENS MODAL (Substitui alerts) ---
        function showMessageModal(title, message, type) {
            const modal = document.getElementById('messageModal');
            const iconContainer = document.getElementById('msgIconContainer');
            const titleEl = document.getElementById('msgTitle');
            const textEl = document.getElementById('msgText');

            titleEl.innerText = title;
            textEl.innerText = message;

            if (type === 'error') {
                iconContainer.className = "mx-auto flex items-center justify-center h-12 w-12 rounded-full bg-red-100 mb-4";
                iconContainer.innerHTML = '<i data-lucide="alert-circle" class="h-6 w-6 text-red-600"></i>';
            } else if (type === 'success') {
                iconContainer.className = "mx-auto flex items-center justify-center h-12 w-12 rounded-full bg-green-100 mb-4";
                iconContainer.innerHTML = '<i data-lucide="check-circle" class="h-6 w-6 text-green-600"></i>';
            } else {
                iconContainer.className = "mx-auto flex items-center justify-center h-12 w-12 rounded-full bg-blue-100 mb-4";
                iconContainer.innerHTML = '<i data-lucide="info" class="h-6 w-6 text-blue-600"></i>';
            }

            modal.classList.remove('hidden');
            lucide.createIcons();
        }

        function hideMessageModal() {
            document.getElementById('messageModal').classList.add('hidden');
        }

        function clearBlockForm(clearAll = false) {
            if (clearAll) {
                document.getElementById('partner').selectedIndex = 0;
                resetRequestorField();
                resetApplicatorField();
                document.getElementById('startTime').value = '';
                document.getElementById('endTime').value = '';
                document.getElementById('totalDuration').value = '';
                updateGlobalState();
            }

            // Reset CROP & BLOCK visibility logic
            // Use resetCropField which handles showing select and hiding custom input
            // But we also need to reset the select index
            const cropSelect = document.getElementById('crop');
            cropSelect.selectedIndex = 0; 
            document.getElementById('otherCropInput').value = '';
            
            // This function handles visibility of input vs select for crop, AND updates block list
            // However, handleCropChange relies on the current state.
            // Let's ensure state is reset first.
            const cropCustomDiv = document.getElementById('crop-custom-div');
            cropSelect.classList.remove('hidden');
            cropCustomDiv.classList.add('hidden');

            handleCropChange(); 
            
            // Reset Block
            document.getElementById('blockId').value = '';
            const bSelect = document.getElementById('blockSelect');
            if(bSelect) bSelect.selectedIndex = 0;
            
            // Reset Target
            const targetSelect = document.getElementById('targetPestSelect');
            if(targetSelect.classList.contains('hidden')){
                resetTargetPestField();
            }
            targetSelect.selectedIndex = 0;
            document.getElementById('targetPestInput').value = '';

            document.getElementById('productsContainer').innerHTML = '';
            addProductRow(); 
            document.getElementById('syrupVolume').value = '';
            document.getElementById('phValue').value = ''; 
            document.getElementById('notes').value = '';
            
            const blockFields = ['crop', 'otherCropInput', 'blockId', 'blockSelect', 'targetPestSelect', 'targetPestInput', 'syrupVolume'];
            blockFields.forEach(id => toggleError(id, false));

            editingIndex = -1;
            const submitBtn = document.getElementById('submitBtn');
            const formTitle = document.getElementById('formTitle');
            const formContainer = document.getElementById('formContainer');
            submitBtn.innerHTML = '<i data-lucide="plus-circle" class="w-4 h-4"></i> <span>Registrar Aplicação</span>';
            submitBtn.classList.remove('bg-blue-600', 'hover:bg-blue-700');
            submitBtn.classList.add('bg-slate-800', 'hover:bg-slate-900');
            formTitle.innerHTML = '<i data-lucide="spray-can" class="text-blue-600"></i> Nova Aplicação';
            formContainer.classList.remove('border-blue-300', 'ring-2', 'ring-blue-100');
            lucide.createIcons();
        }

        // --- ADD ITEM ---
        function addItem(e) {
            e.preventDefault();

            let isValid = true;

            if (!validateHeader()) {
                 isValid = false;
                 document.getElementById('generalDataCard').scrollIntoView({ behavior: 'smooth', block: 'center' });
                 return;
            }

            // Validação Bloco
            const crop = document.getElementById('crop');
            let finalCropName = crop.value;
            
            if (crop.classList.contains('hidden') || crop.value === 'Outros') {
                 // Custom Crop Mode
                 const customInput = document.getElementById('otherCropInput');
                 if (!customInput.value.trim()) { 
                     toggleError('otherCropInput', true); 
                     isValid = false; 
                 } else { 
                     toggleError('otherCropInput', false); 
                     finalCropName = customInput.value.trim();
                 }
            } else {
                 if (!crop.value) { toggleError('crop', true); isValid = false; }
                 else toggleError('crop', false);
            }

            // Bloco
            const blockSelect = document.getElementById('blockSelect');
            let finalBlockValue = "";
            if (blockSelect && !blockSelect.classList.contains('hidden')) {
                 if(!blockSelect.value) { toggleError('blockSelect', true); isValid = false; }
                 else { toggleError('blockSelect', false); finalBlockValue = blockSelect.value; }
            } else {
                const blockId = document.getElementById('blockId');
                if (!blockId.value) { toggleError('blockId', true); isValid = false; }
                else { toggleError('blockId', false); finalBlockValue = blockId.value; }
            }

            // Validação Alvo
            const targetSelect = document.getElementById('targetPestSelect');
            let finalTarget = "";
            if (targetSelect.classList.contains('hidden') || targetSelect.value === 'Outros') {
                const targetInput = document.getElementById('targetPestInput');
                if(!targetInput.value) { toggleError('targetPestInput', true); isValid = false; }
                else { toggleError('targetPestInput', false); finalTarget = targetInput.value; }
            } else {
                if(!targetSelect.value) { toggleError('targetPestSelect', true); isValid = false; }
                else { toggleError('targetPestSelect', false); finalTarget = targetSelect.value; }
            }

            const syrupVolume = document.getElementById('syrupVolume');
            if (!syrupVolume.value) { toggleError('syrupVolume', true); isValid = false; }
            else toggleError('syrupVolume', false);

            const productsList = [];
            const rows = document.querySelectorAll('.product-row');
            if (rows.length === 0) { 
                showMessageModal('Atenção', 'Adicione pelo menos um produto.', 'error');
                return; 
            }

            for (const row of rows) {
                const prodSelect = row.querySelector('.prod-name-select');
                const prodCustom = row.querySelector('.prod-name-custom-input');
                const typeSelect = row.querySelector('.prod-type-select');
                const typeCustom = row.querySelector('.prod-type-custom-input');
                const doseInput = row.querySelector('.prod-dose-input');
                const unitInput = row.querySelector('.prod-unit-input');

                let name = prodSelect.value;
                if (prodSelect.classList.contains('hidden')) name = prodCustom.value.trim();
                let type = typeSelect.value;
                if (typeSelect.classList.contains('hidden')) type = typeCustom.value.trim();
                const dose = doseInput.value.trim();
                const unit = unitInput.value;

                if (!name || name === "") {
                    if (prodSelect.classList.contains('hidden')) prodCustom.classList.add('border-red-500');
                    else { prodSelect.classList.add('border-red-500'); }
                    isValid = false;
                }
                if (!type || type === "") {
                    if (typeSelect.classList.contains('hidden')) typeCustom.classList.add('border-red-500');
                    else { typeSelect.classList.add('border-red-500'); }
                    isValid = false;
                }
                if (!dose) { doseInput.classList.add('border-red-500'); isValid = false; }

                if (name && type && dose) { productsList.push({ name, type, dose, unit }); }
            }

            if (!isValid) {
                showMessageModal('Atenção', 'Por favor, selecione o Produto, o Tipo e informe a Dose.', 'error');
                return;
            }

            const newItem = {
                partner: globalInfo.partner, 
                date: globalInfo.date,
                requestor: globalInfo.requestor,
                applicator: globalInfo.applicator,
                startTime: globalInfo.startTime,
                endTime: globalInfo.endTime,
                duration: globalInfo.duration,
                crop: finalCropName,
                block: finalBlockValue, 
                target: finalTarget, // Valor corrigido
                products: productsList,
                volume: parseFloat(document.getElementById('syrupVolume').value) || 0,
                ph: document.getElementById('phValue').value,
                notes: document.getElementById('notes').value
            };

            if (editingIndex >= 0) {
                appData[editingIndex] = newItem;
                editingIndex = -1; 
                
                // RESTAURA O ESTADO ANTERIOR À EDIÇÃO
                if (lastFormState) {
                    populateForm(lastFormState);
                    lastFormState = null; // Limpa o estado salvo
                    
                    // Reseta UI do botão manualmente para "Registrar"
                    const submitBtn = document.getElementById('submitBtn');
                    const formTitle = document.getElementById('formTitle');
                    const formContainer = document.getElementById('formContainer');

                    submitBtn.innerHTML = '<i data-lucide="plus-circle" class="w-4 h-4"></i> <span>Registrar Aplicação</span>';
                    submitBtn.classList.remove('bg-blue-600', 'hover:bg-blue-700');
                    submitBtn.classList.add('bg-slate-800', 'hover:bg-slate-900');
                    formTitle.innerHTML = '<i data-lucide="spray-can" class="text-blue-600"></i> Nova Aplicação';
                    formContainer.classList.remove('border-blue-300', 'ring-2', 'ring-blue-100');
                    
                    // Foca no Bloco para continuar o trabalho
                    const bSelect = document.getElementById('blockSelect');
                    const bInput = document.getElementById('blockId');
                    setTimeout(() => {
                        if (bSelect && !bSelect.classList.contains('hidden')) bSelect.focus();
                        else if (bInput) bInput.focus();
                    }, 100);
                } else {
                    clearBlockForm(false); 
                }

            } else {
                appData.push(newItem);
                // Mantém o formulário preenchido e foca no Bloco para facilitar digitação sequencial
                const bSelect = document.getElementById('blockSelect');
                const bInput = document.getElementById('blockId');
                if (bSelect && !bSelect.classList.contains('hidden')) {
                    bSelect.focus();
                } else if (bInput && !bInput.classList.contains('hidden')) {
                    bInput.focus();
                    bInput.select();
                }
            }
            saveToStorage();
            renderReport(); 
            renderList();
        }

        function editItem(index) {
            // SALVA O ESTADO ATUAL ANTES DE CARREGAR O ITEM
            lastFormState = getFormStateObject();

            const item = appData[index];
            editingIndex = index; 
            
            // Usa a nova função unificada para preencher
            populateForm(item);
            
            // Ajusta UI para modo de edição
            const submitBtn = document.getElementById('submitBtn');
            const formTitle = document.getElementById('formTitle');
            const formContainer = document.getElementById('formContainer');

            submitBtn.innerHTML = '<i data-lucide="save" class="w-4 h-4"></i> <span>Salvar Alterações</span>';
            submitBtn.classList.remove('bg-slate-800', 'hover:bg-slate-900');
            submitBtn.classList.add('bg-blue-600', 'hover:bg-blue-700');

            formTitle.innerHTML = '<i data-lucide="pencil" class="text-blue-600"></i> Editando Registro';
            formContainer.classList.add('border-blue-300', 'ring-2', 'ring-blue-100');
            formContainer.scrollIntoView({ behavior: 'smooth', block: 'center' });
            lucide.createIcons();
        }

        function removeItem(index) {
            if (editingIndex === index) {
                clearBlockForm(false); 
                editingIndex = -1;
            }
            appData.splice(index, 1);
            saveToStorage();
            renderReport();
            renderList();
        }

        function renderHeaderAndSummary() {
            const summaryContainer = document.getElementById('operationalSummary');
            summaryContainer.classList.remove('hidden');

            const req = globalInfo.requestor || '-';
            const app = globalInfo.applicator || '-';
            
            let timeRange = "Não informado";
            if (globalInfo.startTime) {
                timeRange = `Início: ${globalInfo.startTime}`;
                if (globalInfo.endTime) {
                    timeRange = `${globalInfo.startTime} às ${globalInfo.endTime}`;
                    if (globalInfo.duration) timeRange += ` (${globalInfo.duration})`;
                }
            }

            summaryContainer.innerHTML = `
                <div class="flex flex-col gap-2 text-xs">
                    <div class="flex justify-between items-start border-b border-slate-200 pb-2">
                        <div class="flex flex-col gap-1 w-2/3">
                            <span class="text-[9px] uppercase font-bold text-slate-400 tracking-wider">Responsáveis</span>
                            <div class="flex flex-col sm:flex-row gap-2 sm:gap-4">
                                <span class="text-slate-600 font-medium">Solicitante: <b class="text-slate-800">${req}</b></span>
                                <span class="text-slate-600 font-medium">Aplicador: <b class="text-slate-800">${app}</b></span>
                            </div>
                        </div>
                        <div class="text-right w-1/3">
                            <span class="text-[9px] uppercase font-bold text-slate-400 tracking-wider block mb-1">Tempo de Aplicação</span>
                            <span class="font-bold text-slate-700 text-[10px]">${timeRange}</span>
                        </div>
                    </div>
                </div>
            `;
        }

        function renderList() {
            const list = document.getElementById('itemsList');
            list.innerHTML = '';
            
            const displayData = getFilteredData();

            if (appData.length === 0) {
                list.innerHTML = '<li class="text-center text-slate-400 italic py-2">Nenhum registro adicionado.</li>';
                return;
            } else if (displayData.length === 0) {
                 list.innerHTML = '<li class="text-center text-slate-400 italic py-2">Nenhum registro para este parceiro.</li>';
                 return;
            }

            displayData.forEach((item) => {
                const originalIndex = appData.indexOf(item);
                const activeClass = (originalIndex === editingIndex) ? 'border-blue-400 bg-blue-50 ring-1 ring-blue-200' : 'border-slate-100 bg-slate-50';
                
                const dateParts = item.date.split('-');
                const shortDate = `${dateParts[2]}/${dateParts[1]}`;
                
                let prodSummary = "";
                if (item.products && item.products.length > 0) {
                    prodSummary = item.products[0].name;
                    if (item.products.length > 1) {
                        prodSummary += ` + ${item.products.length - 1} outros`;
                    }
                } else {
                    prodSummary = item.product || "Sem produto";
                }

                let locationLabel = "Bloco";
                if (item.crop && item.crop.toLowerCase().includes('pepino')) {
                    locationLabel = "Setor";
                }

                const li = document.createElement('li');
                li.className = `flex justify-between items-center p-2 rounded border ${activeClass} transition-all`;
                li.innerHTML = `
                    <div class="flex flex-col">
                        <span class="text-[10px] text-slate-400 font-bold uppercase">${shortDate} • ${locationLabel} ${item.block}</span>
                        <span class="font-bold text-slate-700">${prodSummary}</span>
                        <span class="text-xs text-slate-500">${item.target}</span>
                    </div>
                    <div class="flex items-center">
                        <button onclick="editItem(${originalIndex})" class="text-blue-500 hover:bg-blue-100 p-1.5 rounded-md mr-1 transition-colors">
                            <i data-lucide="pencil" width="14"></i>
                        </button>
                        <button onclick="removeItem(${originalIndex})" class="text-red-500 hover:bg-red-100 p-1.5 rounded-md transition-colors">
                            <i data-lucide="trash-2" width="14"></i>
                        </button>
                    </div>
                `;
                list.appendChild(li);
            });
            lucide.createIcons();
        }

        function renderReport() {
            const container = document.getElementById('reportContent');
            const footerContainer = document.getElementById('operationalFooter');
            container.innerHTML = '';
            let totalApps = 0;
            const displayData = getFilteredData();

            if (displayData.length === 0) {
                container.innerHTML = `<div class="p-8 text-center text-slate-400 text-xs italic leading-relaxed h-full flex flex-col items-center justify-center"><i data-lucide="clipboard-list" class="mb-2 w-8 h-8 opacity-20"></i><span>Adicione registros.</span></div>`;
            } else {
                displayData.sort((a, b) => a.block.localeCompare(b.block, undefined, {numeric: true, sensitivity: 'base'}));
                displayData.forEach((item) => { 
                    totalApps++;
                    let locationLabel = "Bloco";
                    if (item.crop && item.crop.toLowerCase().includes('pepino')) locationLabel = "Setor";

                    let productsHtml = '';
                    if (item.products && item.products.length > 0) {
                        productsHtml = `<div class="mt-2 space-y-1">`;
                        item.products.forEach(p => {
                            const unitDisplay = p.unit ? p.unit : '';
                            let typeClass = "text-slate-400";
                            if(p.type === 'Biológico') typeClass = "text-green-600";
                            if(p.type === 'Químico') typeClass = "text-red-600";
                            if(p.type === 'Nutricional') typeClass = "text-blue-600";
                            if(p.type === 'Natural' || p.type === 'Repelente') typeClass = "text-emerald-600";
                            if(p.type === 'Adjuvantes' || p.type === 'Espalhante' || p.type === 'Estabilizador de PH') typeClass = "text-amber-600"; 
                            if(['Inseticidas', 'Fungicidas', 'Herbicidas', 'Acaricidas', 'Nematicidas', 'Bactericidas', 'Rodenticidas', 'Desfolhantes', 'Químico'].includes(p.type)) typeClass = "text-red-600";

                            productsHtml += `
                                <div class="flex justify-between items-center text-xs border-b border-slate-50 pb-1 last:border-0">
                                    <div class="flex items-center gap-1">
                                        <span class="font-bold text-slate-700">• ${p.name}</span>
                                        <span class="text-[9px] uppercase font-bold ${typeClass}">[${p.type || 'Geral'}]</span>
                                    </div>
                                    <span class="font-medium text-slate-600">${p.dose} ${unitDisplay}</span>
                                </div>`;
                        });
                        productsHtml += `</div>`;
                    }
                    
                    const html = `
                    <div class="p-5 hover:bg-slate-50 transition-colors group border-b border-slate-50 last:border-0">
                        <div class="flex flex-col mb-2">
                            <div class="flex items-start justify-between mt-1">
                                <div class="w-full">
                                    <div class="flex justify-between items-center mb-2">
                                        <span class="text-sm font-bold text-slate-700">${locationLabel} ${item.block} • ${item.crop}</span>
                                        <div class="text-xs font-bold text-slate-600 flex items-center gap-1"><span class="text-orange-600 text-sm font-extrabold">Alvo:</span> ${item.target}</div>
                                    </div>
                                    <div class="bg-slate-50/50 rounded-lg border border-slate-100 p-2">
                                        <span class="text-[9px] font-bold text-slate-400 uppercase tracking-wider block mb-1 text-center">Produtos & Dosagens</span>
                                        ${productsHtml}
                                    </div>
                                    <div class="mt-2 flex justify-end items-center gap-3">
                                        ${item.ph ? `<span class="text-[10px] font-bold text-red-600">PH: ${item.ph}</span>` : ''}
                                        <span class="text-[10px] font-bold text-blue-600">Volume Calda: ${item.volume} L</span>
                                    </div>
                                </div>
                            </div>
                            ${item.notes ? `<div class="mt-2 text-[10px] text-slate-400 italic border-l-2 border-slate-200 pl-2">Obs: ${item.notes}</div>` : ''}
                        </div>
                    </div>`;
                    container.innerHTML += html;
                });
            }
            
            footerContainer.innerHTML = `
                <div class="bg-slate-100 rounded-xl p-4 flex justify-center items-center relative overflow-hidden">
                    <div class="absolute top-0 right-0 w-16 h-16 bg-slate-200/50 rounded-full -mr-8 -mt-8 pointer-events-none"></div>
                    <div class="text-center">
                        <div class="text-[10px] text-slate-500 font-bold uppercase mb-0.5">TOTAL DE APLICAÇÕES</div>
                        <div class="text-xl font-extrabold text-slate-800">${totalApps}</div>
                    </div>
                </div>`;
            
            lucide.createIcons();
            renderHeaderAndSummary(); // Atualiza header com dados globais
        }

        // ... (Export functions maintained)
        function copyToWhatsApp() {
            // Usa globalInfo para o cabeçalho
            const displayData = getFilteredData();
            if (displayData.length === 0) {
                showMessageModal('Atenção', 'Adicione registros primeiro para gerar o resumo.', 'error');
                return;
            }

            // CORREÇÃO DA DATA
            let dateStr;
            if (globalInfo.date) {
                const parts = globalInfo.date.split('-');
                dateStr = `${parts[2]}/${parts[1]}/${parts[0]}`;
            } else {
                dateStr = new Date().toLocaleDateString('pt-BR');
            }

            const partnerName = globalInfo.partner || "SPG";
            
            const req = globalInfo.requestor || '-';
            const app = globalInfo.applicator || '-';
            
            let timeRange = "";
            if(globalInfo.startTime && globalInfo.endTime) {
                timeRange = `${globalInfo.startTime} às ${globalInfo.endTime}`;
            }

            let text = `🌱 *Registro Fitossanitário - ${partnerName}*\n`;
            text += `📅 Data: ${dateStr}\n`;
            text += `👨‍🌾 Solic: ${req}\n`;
            text += `🚜 Aplic: ${app}\n`;
            if (timeRange) text += `⏰ Horário: ${timeRange}\n`;
            
            text += `\n*APLICAÇÕES:*\n\n`;

            displayData.forEach(item => {
                let locationLabel = "Bloco";
                if (item.crop && item.crop.toLowerCase().includes('pepino')) locationLabel = "Setor";

                text += `📍 *${locationLabel} ${item.block}* (${item.crop})\n`;
                text += `🎯 Alvo: ${item.target}\n`;
                
                if (item.products && item.products.length > 0) {
                    item.products.forEach(p => {
                        const unitDisplay = p.unit ? p.unit : ''; 
                        text += `🛡️ [${p.type || '?'}] ${p.name} (${p.dose} ${unitDisplay})\n`;
                    });
                }

                text += `💧 Vol: ${item.volume}L`;
                if(item.ph) text += ` | PH: ${item.ph}`;
                text += `\n`;
                if(item.notes) text += `📝 Obs: ${item.notes}\n`;
                text += `----------------\n`;
            });

            const textArea = document.createElement("textarea");
            textArea.value = text;
            textArea.style.position = "fixed";
            textArea.style.left = "-9999px";
            document.body.appendChild(textArea);
            textArea.focus();
            textArea.select();
            
            try {
                document.execCommand('copy');
                showMessageModal('Sucesso!', 'Resumo copiado para a área de transferência.', 'success');
            } catch (err) {
                showMessageModal('Erro', 'Não foi possível copiar o texto.', 'error');
            }
            document.body.removeChild(textArea);
        }

        // --- FUNÇÃO PARA GERAR IMAGEM HD (ATUALIZADA IGUAL AO ANEXO) ---
        async function downloadImage() {
            const element = document.getElementById('report-card');
            // Busca correta do texto do botão
            const btnSpan = document.querySelector('button[onclick="downloadImage()"] span');
            const originalText = btnSpan.innerText;
            btnSpan.innerText = "Gerando Imagem...";

            try {
                // Check for data first
                const data = getFilteredData();
                if (data.length === 0) {
                    showMessageModal('Atenção', 'Adicione registros primeiro.', 'error');
                    return;
                }

                // Configurações idênticas ao código de referência
                const options = {
                    scale: 5, // Alta resolução
                    useCORS: true, 
                    allowTaint: true,
                    scrollY: -window.scrollY,
                    backgroundColor: '#ffffff', 
                    windowWidth: 480, // Força layout mobile
                    onclone: (doc) => {
                        const el = doc.getElementById('report-card');
                        const content = doc.getElementById('reportContent');
                        
                        if (el) { 
                            el.style.width = '450px'; 
                            el.style.maxWidth = '450px';
                            el.style.margin = '0'; 
                            el.style.boxShadow = 'none';
                            el.style.borderRadius = '0';
                            el.style.border = 'none';
                        }
                        if (content) { 
                            content.style.height = 'auto'; 
                            content.style.overflow = 'visible'; 
                            content.style.maxHeight = 'none';
                        }
                    }
                };

                const canvas = await html2canvas(element, options);
                
                // Gera Link de Download
                const imgData = canvas.toDataURL('image/png');
                
                // --- GERAR NOME DO ARQUIVO PERSONALIZADO ---
                const now = new Date();
                const dateStr = now.toLocaleDateString('pt-BR').replace(/\//g, '-');
                const weekNum = getWeekNumber(now);
                let weekday = now.toLocaleDateString('pt-BR', { weekday: 'long' });
                weekday = weekday.charAt(0).toUpperCase() + weekday.slice(1);

                const partnerInput = document.getElementById('partner');
                let partnerName = "Geral"; 
                if (partnerInput && partnerInput.value) {
                    partnerName = partnerInput.value;
                } else if (appData.length > 0 && appData[0].partner) {
                    partnerName = appData[0].partner;
                }

                // LÓGICA DE PREFIXO DO NOME DO ARQUIVO
                let filePrefix = "Resumo de Aplicações Fitossanitárias";

                const fileName = `${filePrefix} - ${weekday} ${dateStr} Semana ${weekNum} - ${partnerName}.png`;

                // Cria elemento temporário para download
                const link = document.createElement('a');
                link.href = imgData;
                link.download = fileName;
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);

            } catch (err) {
                console.error("Erro ao gerar imagem:", err);
                showMessageModal('Erro', 'Falha ao gerar imagem: ' + err.message, 'error');
            } finally {
                btnSpan.innerText = originalText;
            }
        }

        async function downloadPDF() {
             const { jsPDF } = window.jspdf;
            
            // --- ATUALIZAR DADOS NO TEMPLATE PDF ---
            const data = getFilteredData();
            if (data.length === 0) {
                showMessageModal('Atenção', 'Adicione registros primeiro.', 'error');
                return;
            }

            // Dados Gerais
            document.getElementById('pdf-partner').innerText = globalInfo.partner || '-';
            
            // Format Date
            let dateStr;
            if (globalInfo.date) {
                const parts = globalInfo.date.split('-');
                dateStr = `${parts[2]}/${parts[1]}/${parts[0]}`;
                
                // Add Week Number
                const dateObj = new Date(globalInfo.date);
                const weekNum = getWeekNumber(dateObj);
                document.getElementById('pdf-week').innerText = ` - Semana ${weekNum}`;
            } else {
                 document.getElementById('pdf-week').innerText = '';
            }
            document.getElementById('pdf-date').innerText = dateStr || '-';
            
            document.getElementById('pdf-requestor').innerText = globalInfo.requestor || '-';
            document.getElementById('pdf-applicator').innerText = globalInfo.applicator || '-';
            document.getElementById('pdf-total-blocks').innerText = data.length;

            let timeStr = "-";
            if(globalInfo.startTime && globalInfo.endTime) {
                timeStr = `${globalInfo.startTime} às ${globalInfo.endTime}`;
                if (globalInfo.duration) timeStr += ` (${globalInfo.duration})`;
            }
            document.getElementById('pdf-time').innerText = timeStr;

            // Preencher Tabela
            const tbody = document.getElementById('pdf-table-body');
            tbody.innerHTML = '';
            
            data.forEach(item => {
                let locationLabel = "Bloco";
                if (item.crop && item.crop.toLowerCase().includes('pepino')) locationLabel = "Setor";
                
                let productsStr = "";
                if (item.products && item.products.length > 0) {
                    productsStr = item.products.map(p => `<div>• [${p.type}] ${p.name} (${p.dose}${p.unit ? ' ' + p.unit : ''})</div>`).join('');
                } 

                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td>${locationLabel} ${item.block}</td>
                    <td>${item.crop}</td>
                    <td>${item.target}</td>
                    <td>${productsStr}</td>
                    <td>${item.volume}</td>
                    <td>${item.ph || '-'}</td>
                    <td>${item.notes || '-'}</td>
                `;
                tbody.appendChild(tr);
            });

            // --- GERAÇÃO PDF ---
            const element = document.getElementById('technical-report-template');
            const btnText = document.querySelector('button[onclick="downloadPDF()"] span');
            const originalText = btnText.innerText;
            btnText.innerText = "Gerando...";

            try {
                // ALTERAÇÃO: Não movemos mais o elemento original para a tela.
                // Usamos o onclone do html2canvas para posicionar apenas a cópia virtual.
                
                const canvas = await html2canvas(element, { 
                    scale: 2, 
                    useCORS: true, 
                    backgroundColor: '#ffffff',
                    windowWidth: 794, // Garante contexto largo suficiente
                    onclone: (clonedDoc) => {
                        const clone = clonedDoc.getElementById('technical-report-template');
                        if (clone) {
                            // Move apenas o clone para a posição visível (dentro do documento virtual)
                            clone.style.top = '0';
                            clone.style.left = '0';
                            clone.style.position = 'relative'; 
                            clone.style.zIndex = 'auto';
                        }
                    }
                });

                const imgData = canvas.toDataURL('image/png');
                const pdf = new jsPDF('p', 'mm', 'a4');
                const pdfWidth = pdf.internal.pageSize.getWidth();
                const pdfHeight = (canvas.height * pdfWidth) / canvas.width;

                pdf.addImage(imgData, 'PNG', 0, 0, pdfWidth, pdfHeight);
                pdf.save(`Relatorio_Tecnico_${new Date().toISOString().slice(0,10)}.pdf`);
            } catch (err) {
                console.error(err);
                showMessageModal('Erro', 'Falha ao gerar PDF.', 'error');
            } finally {
                btnText.innerText = originalText;
            }
        }
    </script>
</body>
</html>

