<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Registro Fitossanitário - SPG Oásis</title>
    
    <!-- Configurações PWA -->
    <link rel="icon" type="image/png" href="https://i.imgur.com/f7UnnL0.png">
    <link rel="apple-touch-icon" href="https://i.imgur.com/f7UnnL0.png">
    <meta name="theme-color" content="#ffffff">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="SPG Fito">
    
    <!-- Bibliotecas Externas -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <!-- HTML2Canvas + jsPDF -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    
    <style>
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; -webkit-tap-highlight-color: transparent; }
        .hide-scrollbar::-webkit-scrollbar { display: none; }
        .hide-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        input, select { line-height: 1.5; }
        
        /* Estilos para o Relatório Técnico (PDF) */
        #technical-report-template {
            width: 794px; /* A4 Width at 96dpi approx */
            min-height: 1123px; /* A4 Height */
            background: white;
            padding: 40px;
            box-sizing: border-box;
            position: absolute;
            top: -9999px;
            left: -9999px;
            font-family: 'Helvetica', 'Arial', sans-serif;
            color: #333;
        }
        .tech-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
            font-size: 11px;
        }
        .tech-table th {
            background-color: #f1f5f9;
            color: #475569;
            font-weight: bold;
            text-transform: uppercase;
            padding: 8px;
            border: 1px solid #e2e8f0;
            text-align: left;
        }
        .tech-table td {
            padding: 8px;
            border: 1px solid #e2e8f0;
            vertical-align: top;
        }
        .tech-header {
            border-bottom: 2px solid #0f172a;
            padding-bottom: 20px;
            margin-bottom: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        /* Animação suave para troca de inputs */
        .fade-in {
            animation: fadeIn 0.2s ease-in-out;
        }
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
    </style>
</head>
<body class="bg-slate-100 text-slate-800 min-h-screen pb-20 select-none">

    <!-- Navbar -->
    <div class="bg-white border-b border-slate-200 px-4 py-3 flex flex-col md:flex-row justify-between items-center shadow-sm sticky top-0 z-40 gap-3">
        <div class="flex items-center gap-3 w-full md:w-auto">
            <img src="https://i.imgur.com/f7UnnL0.png" alt="Logo SPG" class="w-8 h-8 rounded-lg shadow-sm border border-slate-100">
            <div>
                <h1 class="text-sm font-bold text-slate-800 leading-tight">SPG FITOSSANITÁRIO</h1>
                <p class="text-[10px] text-slate-500 font-medium">Registro de Aplicações de Defensivos</p>
            </div>
        </div>
        <div class="flex gap-2 w-full md:w-auto overflow-x-auto pb-1 md:pb-0">
            <!-- Botão WhatsApp -->
            <button id="btnZap" onclick="copyToWhatsApp()" class="flex-1 md:flex-none flex items-center justify-center gap-2 px-3 py-2 bg-emerald-500 hover:bg-emerald-600 text-white rounded-lg text-xs font-bold shadow-lg shadow-emerald-500/20 transition-all active:scale-95 active:bg-emerald-700 whitespace-nowrap">
                <i data-lucide="message-circle" class="w-4 h-4"></i>
                <span>Zap</span>
            </button>
            
            <!-- Botão Imagem -->
            <button onclick="downloadImage()" class="flex-1 md:flex-none flex items-center justify-center gap-2 px-3 py-2 bg-indigo-500 hover:bg-indigo-600 text-white rounded-lg text-xs font-bold shadow-lg shadow-indigo-500/20 transition-all active:scale-95 active:bg-indigo-700 whitespace-nowrap">
                <i data-lucide="image" class="w-4 h-4"></i>
                <span>Imagem</span>
            </button>

            <!-- Botão PDF -->
            <button id="pdfBtn" type="button" onclick="downloadPDF()" class="flex-1 md:flex-none flex items-center justify-center gap-2 px-3 py-2 bg-red-600 hover:bg-red-700 text-white rounded-lg text-xs font-bold shadow-lg shadow-red-600/20 transition-all active:scale-95 active:bg-red-800 whitespace-nowrap">
                <i data-lucide="file-down" class="w-4 h-4"></i>
                <span>PDF Técnico</span>
            </button>
        </div>
    </div>

    <div class="container mx-auto p-4 flex flex-col lg:flex-row gap-8 mt-4">
        
        <!-- COLUNA DA ESQUERDA: CONTROLES -->
        <div class="w-full lg:w-2/5 space-y-4">
            
            <!-- 1. DADOS GERAIS E OPERACIONAIS (INDEPENDENTE) -->
            <div class="bg-blue-50 p-5 rounded-2xl shadow-sm border border-blue-100 transition-colors">
                <h2 class="text-sm font-bold text-blue-800 mb-3 flex items-center gap-2">
                    <i data-lucide="clipboard-check" class="text-blue-600"></i> Dados Gerais da Aplicação
                </h2>
                
                <!-- GERAL -->
                <div class="grid grid-cols-2 gap-3 mb-3">
                    <div>
                        <label class="text-[10px] font-bold text-blue-600 uppercase tracking-wide mb-1 block">Local</label>
                        <select id="partner" required onchange="updateGlobalState()" class="w-full p-2 border border-blue-200 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none text-sm bg-white">
                            <option value="">Selecione...</option>
                            <option value="SPG Oásis">SPG Oásis</option>
                            <option value="SPG Sede">SPG Sede</option>
                        </select>
                    </div>
                    <div>
                        <label class="text-[10px] font-bold text-blue-600 uppercase tracking-wide mb-1 block">Data</label>
                        <input type="date" id="appDate" required onchange="updateGlobalState()" class="w-full p-2 border border-blue-200 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none text-sm bg-white text-slate-600">
                    </div>
                </div>

                <!-- OPERACIONAL -->
                <div class="grid grid-cols-2 gap-3 mb-3">
                    <div class="relative">
                        <label class="text-[10px] font-bold text-slate-500 mb-1 block">Solicitante</label>
                        <select id="requestor" onchange="toggleOtherRequestorInput(); updateGlobalState();" class="w-full p-2 border border-slate-300 rounded-lg text-sm bg-white focus:ring-2 focus:ring-blue-500 outline-none">
                            <option value="">Selecione...</option>
                            <option value="Marcio">Marcio</option>
                            <option value="Outro">Outro (Digitar)</option>
                        </select>
                        <div id="requestor-custom-div" class="hidden relative w-full fade-in">
                            <input type="text" id="otherRequestorInput" oninput="updateGlobalState()" class="w-full p-2 pr-8 border border-slate-300 rounded-lg text-sm bg-white focus:ring-2 focus:ring-blue-500 outline-none" placeholder="Nome do Solicitante">
                            <button type="button" onclick="resetRequestorField(); updateGlobalState();" class="absolute right-2 top-1/2 -translate-y-1/2 text-slate-400 hover:text-red-500">
                                <i data-lucide="x-circle" width="14"></i>
                            </button>
                        </div>
                    </div>

                    <div class="relative">
                        <label class="text-[10px] font-bold text-slate-500 mb-1 block">Aplicador</label>
                        <select id="applicator" onchange="toggleOtherApplicatorInput(); updateGlobalState();" class="w-full p-2 border border-slate-300 rounded-lg text-sm bg-white focus:ring-2 focus:ring-blue-500 outline-none">
                            <option value="">Selecione...</option>
                            <option value="Equipe Erisvaldo">Equipe Erisvaldo</option>
                            <option value="Outro">Outro (Digitar)</option>
                        </select>
                        <div id="applicator-custom-div" class="hidden relative w-full fade-in">
                            <input type="text" id="otherApplicatorInput" oninput="updateGlobalState()" class="w-full p-2 pr-8 border border-slate-300 rounded-lg text-sm bg-white focus:ring-2 focus:ring-blue-500 outline-none" placeholder="Nome do Aplicador">
                            <button type="button" onclick="resetApplicatorField(); updateGlobalState();" class="absolute right-2 top-1/2 -translate-y-1/2 text-slate-400 hover:text-red-500">
                                <i data-lucide="x-circle" width="14"></i>
                            </button>
                        </div>
                    </div>
                </div>

                <div class="grid grid-cols-3 gap-2 mb-3">
                    <div>
                        <label class="text-[10px] font-bold text-slate-500 mb-1 block">Início</label>
                        <input type="time" id="startTime" onchange="calculateDuration(); updateGlobalState();" class="w-full p-2 border border-slate-300 rounded-lg text-sm bg-white focus:ring-2 focus:ring-blue-500 outline-none">
                    </div>
                    <div>
                        <label class="text-[10px] font-bold text-slate-500 mb-1 block">Fim</label>
                        <input type="time" id="endTime" onchange="calculateDuration(); updateGlobalState();" class="w-full p-2 border border-slate-300 rounded-lg text-sm bg-white focus:ring-2 focus:ring-blue-500 outline-none">
                    </div>
                    <div>
                        <label class="text-[10px] font-bold text-slate-500 mb-1 block">Total</label>
                        <input type="text" id="totalDuration" readonly placeholder="--:--" class="w-full p-2 border border-slate-200 bg-slate-100 rounded-lg text-sm text-slate-600 focus:outline-none font-semibold">
                    </div>
                </div>
            </div>

            <!-- 2. FORMULÁRIO DE LANÇAMENTO (BLOCO) -->
            <div id="formContainer" class="bg-white p-6 rounded-2xl shadow-sm border border-slate-200 transition-colors duration-300">
                <div class="flex justify-between items-center mb-4">
                    <h2 id="formTitle" class="text-lg font-bold text-slate-800 flex items-center gap-2">
                        <i data-lucide="spray-can" class="text-blue-600"></i> Nova Aplicação
                    </h2>
                    <button type="button" onclick="clearBlockForm()" class="text-xs font-semibold text-slate-400 hover:text-red-500 transition-colors flex items-center gap-1">
                        <i data-lucide="eraser" class="w-3 h-3"></i> Limpar
                    </button>
                </div>
                
                <form id="appForm" onsubmit="addItem(event)" class="space-y-4">
                    
                    <!-- LINHA 3: CULTURA E BLOCO -->
                    <div class="grid grid-cols-2 gap-3">
                        <div>
                            <label class="text-xs font-bold text-slate-500 uppercase mb-1 block">Cultura</label>
                            <select id="crop" onchange="handleCropChange()" required class="w-full p-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none text-sm bg-white">
                                <option value="Brócolis">Brócolis</option>
                                <option value="Couve-Flor">Couve-Flor</option>
                                <option value="Pepino">Pepino</option>
                                <option value="Outros">Outros</option>
                            </select>
                            <input type="text" id="otherCropInput" class="hidden w-full p-2 mt-2 border border-blue-200 bg-blue-50 text-blue-800 font-semibold rounded-lg text-sm focus:ring-2 focus:ring-blue-500 outline-none" placeholder="Qual cultura?">
                        </div>
                        <div>
                            <label id="blockLabel" class="text-xs font-bold text-slate-500 uppercase mb-1 block">Nº Bloco/Talhão</label>
                            <input type="text" id="blockId" required placeholder="Ex: 1 - A" class="w-full p-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none text-sm bg-white">
                        </div>
                    </div>

                    <!-- ALVO BIOLÓGICO -->
                    <div>
                        <label class="text-xs font-bold text-slate-500 uppercase mb-1 block">Alvo Biológico (Praga/Doença)</label>
                        <input type="text" id="targetPest" required placeholder="Ex: Traça, Pulgão, Alternaria..." class="w-full p-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none text-sm">
                    </div>

                    <!-- LISTA DE PRODUTOS DINÂMICA -->
                    <div class="bg-slate-50 p-3 rounded-lg border border-slate-100">
                        <label class="text-[10px] font-bold text-blue-600 uppercase tracking-wide mb-2 flex justify-between items-center">
                            <span>Produtos & Dosagens</span>
                            <button type="button" onclick="addProductRow()" class="text-blue-500 hover:text-blue-700 flex items-center gap-1 text-[9px] bg-blue-50 px-2 py-1 rounded border border-blue-200 shadow-sm transition-all active:scale-95">
                                <i data-lucide="plus" width="10"></i> Add Produto
                            </button>
                        </label>
                        
                        <div id="productsContainer" class="space-y-2">
                            <!-- JS vai injetar linhas aqui -->
                        </div>
                    </div>

                    <!-- DADOS DA CALDA (VOLUME E PH) -->
                    <div class="grid grid-cols-2 gap-3">
                         <div class="col-span-1">
                            <label class="text-[10px] font-bold text-blue-600 mb-1 block">Vol. Calda (L)</label>
                            <input type="number" id="syrupVolume" required placeholder="200" class="w-full p-2 border border-blue-200 bg-blue-50 rounded-lg text-sm text-blue-800 font-bold focus:outline-none focus:ring-2 focus:ring-blue-500">
                        </div>
                         <div class="col-span-1">
                            <label class="text-[10px] font-bold text-purple-600 mb-1 block">P.H.</label>
                            <input type="text" id="phValue" placeholder="Ex: 6.0" inputmode="decimal" class="w-full p-2 border border-purple-200 bg-purple-50 rounded-lg text-sm text-purple-800 font-bold focus:outline-none focus:ring-2 focus:ring-purple-500">
                        </div>
                    </div>
                    
                    <div class="mt-2">
                        <label class="text-[10px] font-bold text-slate-500 mb-1 block">Observações (Opcional)</label>
                        <input type="text" id="notes" placeholder="Ex: Vento calmo..." class="w-full p-2 border border-slate-300 rounded-lg text-sm bg-white focus:ring-2 focus:ring-blue-500 outline-none">
                   </div>

                    <button type="submit" id="submitBtn" class="w-full bg-slate-800 hover:bg-slate-900 text-white font-bold py-3 rounded-xl transition-all flex justify-center items-center gap-2 mt-4 active:scale-95">
                        <i data-lucide="plus-circle" class="w-4 h-4"></i> <span>Registrar Aplicação</span>
                    </button>
                </form>
            </div>

            <!-- Lista de Itens -->
            <div class="bg-white p-6 rounded-2xl shadow-sm border border-slate-200">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-sm font-bold text-slate-700">Aplicações Registradas</h3>
                    <button onclick="clearAll()" class="text-xs text-red-500 hover:text-red-700 font-bold underline">Limpar Tudo</button>
                </div>
                <ul id="itemsList" class="space-y-2 text-sm text-slate-600">
                    <!-- JS -->
                </ul>
            </div>
        </div>

        <!-- PREVIEW -->
        <div class="w-full lg:w-3/5 flex flex-col bg-slate-200/50 p-4 rounded-3xl border border-slate-300/50 min-h-[calc(100vh-6rem)]">
            
            <div id="report-card" class="w-full flex-1 flex flex-col bg-white shadow-2xl overflow-hidden border border-slate-100 relative">
                
                <!-- Cabeçalho (Cinza/Slate) -->
                <div class="bg-gradient-to-br from-slate-700 to-slate-900 p-6 text-white relative overflow-hidden flex flex-col justify-start shrink-0 gap-3 antialiased">
                    <img src="https://i.imgur.com/f7UnnL0.png" alt="Logo SPG" class="absolute top-4 right-4 w-24 h-24 z-0" style="image-rendering: -webkit-optimize-contrast;">
                    <div class="relative z-10 w-full pr-24"> 
                        <h2 id="reportTitle" class="text-sm font-bold leading-snug tracking-normal">
                            <!-- Injetado via JS -->
                        </h2>
                        <div class="mt-3 pt-3 border-t border-white/20">
                             <span id="headerDateTime" class="text-xs font-medium text-slate-300 block opacity-90 tracking-wide">
                                <!-- Injetado via JS -->
                            </span>
                        </div>
                    </div>
                </div>
                
                <!-- Painel de DADOS OPERACIONAIS -->
                <div id="operationalSummary" class="hidden bg-slate-50 border-b border-slate-200 p-4">
                    <!-- Preenchido via JS -->
                </div>

                <!-- Painel de Totais -->
                <div id="operationalFooter" class="bg-white border-b border-slate-200 p-4 shrink-0">
                     <!-- Conteúdo injetado via JS -->
                </div>

                <!-- Conteúdo -->
                <div id="reportContent" class="divide-y divide-slate-50 flex-1 overflow-y-auto">
                    <div class="p-8 text-center text-slate-400 text-xs italic leading-relaxed h-full flex items-center justify-center">Utilize o formulário para registrar as aplicações.</div>
                </div>

                <!-- Rodapé da Marca -->
                <div class="bg-slate-100 p-3 text-center border-t border-slate-200 shrink-0">
                    <div class="flex justify-center items-center gap-2 text-[10px] text-slate-400 font-medium uppercase tracking-widest leading-relaxed">
                        SPG • Controle Fitossanitário
                    </div>
                </div>

            </div>
        </div>
    </div>

    <!-- ELEMENTO OCULTO PARA O RELATÓRIO TÉCNICO PDF -->
    <div id="technical-report-template">
        <!-- Mantido igual ao anterior -->
        <div class="tech-header">
            <div>
                <h1 style="font-size: 24px; font-weight: bold; color: #1e293b; margin: 0;">RELATÓRIO DE APLICAÇÃO</h1>
                <p style="font-size: 14px; color: #64748b; margin: 5px 0 0 0;">Controle Fitossanitário • SPG</p>
            </div>
            <img src="https://i.imgur.com/f7UnnL0.png" style="height: 80px; width: auto;">
        </div>

        <div style="display: flex; justify-content: space-between; margin-bottom: 20px; font-size: 12px; border: 1px solid #e2e8f0; padding: 15px; background-color: #f8fafc;">
            <div style="line-height: 1.8;">
                <div><strong>Local:</strong> <span id="pdf-partner"></span></div>
                <div><strong>Data:</strong> <span id="pdf-date"></span></div>
            </div>
            <div style="line-height: 1.8;">
                <div><strong>Solicitante:</strong> <span id="pdf-requestor"></span></div>
                <div><strong>Aplicador:</strong> <span id="pdf-applicator"></span></div>
            </div>
            <div style="line-height: 1.8; text-align: right;">
                <div><strong>Horário:</strong> <span id="pdf-time"></span></div>
                <div><strong>Total Blocos:</strong> <span id="pdf-total-blocks"></span></div>
            </div>
        </div>

        <h3 style="font-size: 14px; font-weight: bold; color: #1e293b; border-bottom: 1px solid #cbd5e1; padding-bottom: 5px; margin-bottom: 10px;">DETALHAMENTO DAS APLICAÇÕES</h3>
        
        <table class="tech-table">
            <thead>
                <tr>
                    <th style="width: 15%;">Setor/Bloco</th>
                    <th style="width: 15%;">Cultura</th>
                    <th style="width: 10%;">Alvo</th>
                    <th style="width: 30%;">Produtos (Dose)</th>
                    <th style="width: 10%;">Vol. (L)</th>
                    <th style="width: 5%;">pH</th>
                    <th style="width: 15%;">Obs</th>
                </tr>
            </thead>
            <tbody id="pdf-table-body">
                <!-- Linhas injetadas via JS -->
            </tbody>
        </table>

        <div style="margin-top: 60px; display: flex; justify-content: space-between; page-break-inside: avoid;">
            <div style="width: 40%; border-top: 1px solid #333; text-align: center; font-size: 11px; padding-top: 5px;">
                Responsável Técnico
            </div>
            <div style="width: 40%; border-top: 1px solid #333; text-align: center; font-size: 11px; padding-top: 5px;">
                Responsável Aplicação
            </div>
        </div>
        
        <div style="position: absolute; bottom: 30px; width: 100%; text-align: center; font-size: 10px; color: #94a3b8; border-top: 1px solid #e2e8f0; padding-top: 10px;">
            Documento gerado eletronicamente pelo sistema SPG Fitossanitário.
        </div>
    </div>

    <!-- JAVASCRIPT LOGIC -->
    <script>
        console.log("Aplicação 'Fitossanitário SPG' carregada.");

        let appData = [];
        let editingIndex = -1;
        const STORAGE_KEY = 'spg_fitosanitario_data'; 
        const GLOBAL_KEY = 'spg_global_info'; 

        // Estado Global
        let globalInfo = {
            partner: '',
            date: '',
            requestor: '',
            applicator: '',
            startTime: '',
            endTime: '',
            duration: ''
        };

        // INICIALIZAÇÃO
        lucide.createIcons();
        document.getElementById('appDate').valueAsDate = new Date();
        addProductRow();
        loadFromStorage();
        // Force update after load
        updateDynamicTitle();
        calculateDuration();
        updateGlobalState();

        // --- ATUALIZAÇÃO EM TEMPO REAL (DADOS GERAIS) ---
        function updateGlobalState() {
            // Coleta dados dos campos globais
            globalInfo.partner = document.getElementById('partner').value;
            globalInfo.date = document.getElementById('appDate').value;
            
            // Solicitante
            const reqSelect = document.getElementById('requestor');
            if (!reqSelect.classList.contains('hidden')) {
                 globalInfo.requestor = reqSelect.value;
            } else {
                 globalInfo.requestor = document.getElementById('otherRequestorInput').value;
            }

            // Aplicador
            const appSelect = document.getElementById('applicator');
            if (!appSelect.classList.contains('hidden')) {
                globalInfo.applicator = appSelect.value;
            } else {
                globalInfo.applicator = document.getElementById('otherApplicatorInput').value;
            }

            globalInfo.startTime = document.getElementById('startTime').value;
            globalInfo.endTime = document.getElementById('endTime').value;
            globalInfo.duration = document.getElementById('totalDuration').value;

            localStorage.setItem(GLOBAL_KEY, JSON.stringify(globalInfo));
            updateDynamicTitle();
            renderHeaderAndSummary();
        }

        // --- FUNÇÕES DE FORMATAÇÃO ---
        function formatDecimalInput(input) {
            let value = input.value;
            value = value.replace('.', ',');
            value = value.replace(/[^0-9,]/g, '');
            const parts = value.split(',');
            if (parts.length > 2) {
                value = parts[0] + ',' + parts.slice(1).join('');
            }
            input.value = value;
        }

        // --- LÓGICA DE PRODUTOS DINÂMICOS ---
        function addProductRow(name = '', dose = '', unit = 'ml', type = '') { 
            const container = document.getElementById('productsContainer');
            const rowId = 'prod-row-' + Date.now() + Math.random().toString(36).substr(2, 5);
            
            const div = document.createElement('div');
            div.className = "flex gap-2 items-start product-row animate-fade-in flex-wrap sm:flex-nowrap"; 
            div.id = rowId;
            
            const units = ['ml', 'L', 'g', 'Kg'];
            const optionsHtml = units.map(u => `<option value="${u}" ${u === unit ? 'selected' : ''}>${u}</option>`).join('');

            const standardTypes = [
                'Acaricidas', 'Adjuvantes', 'Bactericidas', 'Biológico', 'Desfolhantes',
                'Fungicidas', 'Herbicidas', 'Inseticidas', 'Natural', 'Nematicidas',
                'Nutricional', 'Repelente', 'Rodenticidas'
            ];

            const standardProducts = [
                "Alexia", "Alliado", "Avatar", "Azospirilium", "Beauveria", "Bioimpeto", 
                "Carbon N-10", "Coda Sul PH", "Crystal-BT", "Detergente", "Dipel", "Durivo", "Evidence", "Full Grow", 
                "Joiner", "Karate", "Kasumin", "Lannate", "Mancozeb", "Manipueira", "Metarhizium", 
                "Mukussan", "Óleo Vegetal", "Shenzi", "Speed Dil", "Timorex", "Trichoderma", "Vinagre", "Xixi"
            ];
            
            let isCustom = false;
            let displayType = type;
            let customTypeValue = '';

            if (type && !standardTypes.includes(type) && type !== 'Outros') {
                isCustom = true;
                customTypeValue = type;
                displayType = 'Outros';
            } else if (type === 'Outros') {
                 isCustom = true;
                 displayType = 'Outros';
            }

            const typesOptionsHtml = [...standardTypes, 'Outros'].map(t => 
                `<option value="${t}" ${t === displayType ? 'selected' : ''}>${t}</option>`
            ).join('');

            let isCustomProduct = false;
            let displayProduct = name;
            let customProductValue = '';

            if (name && !standardProducts.includes(name)) {
                isCustomProduct = true;
                customProductValue = name;
                displayProduct = 'Outros';
            } 
            
            const productsOptionsHtml = [...standardProducts, 'Outros'].map(p => 
                `<option value="${p}" ${p === displayProduct ? 'selected' : ''}>${p}</option>`
            ).join('');
            
            const selectClass = isCustom ? "prod-type-select hidden w-full p-2 border border-slate-300 rounded-lg text-sm bg-white focus:ring-2 focus:ring-blue-500 outline-none" : `prod-type-select w-full p-2 border border-slate-300 rounded-lg text-sm bg-white focus:ring-2 focus:ring-blue-500 outline-none ${!type ? 'text-slate-400' : 'text-slate-800'}`;
            const customInputDivClass = isCustom ? "prod-type-custom-div w-full relative" : "prod-type-custom-div hidden w-full relative";
            const selectRequired = !isCustom ? 'required' : '';
            const inputRequired = isCustom ? 'required' : '';

            const prodSelectClass = isCustomProduct ? "prod-name-select hidden w-full p-2 border border-slate-300 rounded-lg text-sm bg-white focus:ring-2 focus:ring-blue-500 outline-none" : `prod-name-select w-full p-2 border border-slate-300 rounded-lg text-sm bg-white focus:ring-2 focus:ring-blue-500 outline-none ${!name ? 'text-slate-400' : 'text-slate-800'}`;
            const prodCustomInputDivClass = isCustomProduct ? "prod-name-custom-div w-full relative" : "prod-name-custom-div hidden w-full relative";
            const prodSelectRequired = !isCustomProduct ? 'required' : '';
            const prodInputRequired = isCustomProduct ? 'required' : '';

            div.innerHTML = `
                <div class="w-full sm:w-auto sm:flex-grow relative">
                    <select onchange="this.classList.remove('text-slate-400'); this.classList.add('text-slate-800'); toggleRowCustomProduct(this)" class="${prodSelectClass}" ${prodSelectRequired}>
                        <option value="" disabled ${!name ? 'selected' : ''}>Selecione o Produto...</option>
                        ${productsOptionsHtml}
                    </select>
                    <div class="${prodCustomInputDivClass}">
                        <input type="text" placeholder="Nome do Produto" class="prod-name-custom-input w-full p-2 pr-6 border border-slate-300 rounded-lg text-sm bg-white focus:ring-2 focus:ring-blue-500 outline-none fade-in" value="${customProductValue}" ${prodInputRequired}>
                        <button type="button" onclick="resetRowProduct(this)" class="absolute right-1 top-1/2 -translate-y-1/2 text-slate-400 hover:text-red-500 p-1">
                            <i data-lucide="x-circle" width="14"></i>
                        </button>
                    </div>
                </div>
                <div class="w-1/2 sm:w-28 relative">
                     <select onchange="this.classList.remove('text-slate-400'); this.classList.add('text-slate-800'); toggleRowCustomType(this)" class="${selectClass}" ${selectRequired}>
                        <option value="" disabled ${!type ? 'selected' : ''}>Selecione...</option>
                        ${typesOptionsHtml}
                    </select>
                    <div class="${customInputDivClass}">
                        <input type="text" placeholder="Qual?" class="prod-type-custom-input w-full p-2 pr-6 border border-slate-300 rounded-lg text-sm bg-white focus:ring-2 focus:ring-blue-500 outline-none fade-in" value="${customTypeValue}" ${inputRequired}>
                        <button type="button" onclick="resetRowType(this)" class="absolute right-1 top-1/2 -translate-y-1/2 text-slate-400 hover:text-red-500 p-1">
                            <i data-lucide="x-circle" width="14"></i>
                        </button>
                    </div>
                </div>
                <div class="w-1/4 sm:w-20">
                    <input type="text" inputmode="decimal" oninput="formatDecimalInput(this)" placeholder="Dose" class="prod-dose-input w-full p-2 border border-slate-300 rounded-lg text-sm bg-white focus:ring-2 focus:ring-blue-500 outline-none" value="${dose}" required>
                </div>
                <div class="w-1/4 sm:w-20">
                    <select class="prod-unit-input w-full p-2 border border-slate-300 rounded-lg text-sm bg-white focus:ring-2 focus:ring-blue-500 outline-none">
                        ${optionsHtml}
                    </select>
                </div>
                <button type="button" onclick="removeProductRow('${rowId}')" class="text-red-400 hover:text-red-600 hover:bg-red-50 p-2 rounded-lg transition-colors h-[38px] flex items-center justify-center" tabindex="-1">
                    <i data-lucide="trash-2" width="16"></i>
                </button>
            `;
            container.appendChild(div);
            lucide.createIcons();
        }

        // --- TOGGLE FUNCTIONS ---
        function toggleRowCustomProduct(selectElement) {
            if(selectElement.value === 'Outros') {
                const parent = selectElement.parentElement;
                const customDiv = parent.querySelector('.prod-name-custom-div');
                const customInput = customDiv.querySelector('input');
                selectElement.classList.add('hidden');
                selectElement.required = false; 
                customDiv.classList.remove('hidden');
                customInput.required = true; 
                customInput.focus();
            }
        }
        function resetRowProduct(btnElement) {
            const customDiv = btnElement.parentElement;
            const parent = customDiv.parentElement;
            const select = parent.querySelector('.prod-name-select');
            const input = customDiv.querySelector('input');
            input.value = ''; 
            input.required = false; 
            select.selectedIndex = 0; 
            select.classList.remove('hidden');
            select.classList.add('text-slate-400'); 
            select.required = true; 
            customDiv.classList.add('hidden');
        }
        function toggleRowCustomType(selectElement) {
            if(selectElement.value === 'Outros') {
                const parent = selectElement.parentElement;
                const customDiv = parent.querySelector('.prod-type-custom-div');
                const customInput = customDiv.querySelector('input');
                selectElement.classList.add('hidden');
                selectElement.required = false;
                customDiv.classList.remove('hidden');
                customInput.required = true;
                customInput.focus();
            }
        }
        function resetRowType(btnElement) {
            const customDiv = btnElement.parentElement;
            const parent = customDiv.parentElement;
            const select = parent.querySelector('.prod-type-select');
            const input = customDiv.querySelector('input');
            input.value = ''; 
            input.required = false;
            select.value = ''; 
            select.selectedIndex = 0; 
            select.classList.remove('hidden');
            select.classList.add('text-slate-400');
            select.required = true;
            customDiv.classList.add('hidden');
        }
        function removeProductRow(id) {
            const container = document.getElementById('productsContainer');
            if (container.children.length > 1) {
                document.getElementById(id).remove();
            } else {
                const row = document.getElementById(id);
                const prodResetBtn = row.querySelector('button[onclick^="resetRowProduct"]');
                if(prodResetBtn) resetRowProduct(prodResetBtn);
                const typeResetBtn = row.querySelector('button[onclick^="resetRowType"]');
                if(typeResetBtn) resetRowType(typeResetBtn);
                row.querySelector('.prod-dose-input').value = '';
            }
        }

        // --- CÁLCULO DE TEMPO ---
        function calculateDuration() {
            const start = document.getElementById('startTime').value;
            const end = document.getElementById('endTime').value;
            const totalInput = document.getElementById('totalDuration');
            if (start && end) {
                const startD = new Date(`2000-01-01T${start}`);
                const endD = new Date(`2000-01-01T${end}`);
                let diffMs = endD - startD;
                if (diffMs < 0) diffMs += 24 * 60 * 60 * 1000;
                const totalMinutes = Math.floor(diffMs / 60000);
                const hours = Math.floor(totalMinutes / 60);
                const minutes = totalMinutes % 60;
                let durationStr = "";
                if (hours > 0) durationStr += `${hours}h `;
                durationStr += `${minutes}min`;
                totalInput.value = durationStr;
            } else {
                totalInput.value = "";
            }
            // Trigger update of global state when calc finishes
            updateGlobalState();
        }

        // --- PERSISTÊNCIA ---
        function saveToStorage() {
            try { localStorage.setItem(STORAGE_KEY, JSON.stringify(appData)); } catch (e) { console.error("Erro ao salvar", e); }
        }

        function loadFromStorage() {
            try {
                // 1. Carregar Dados Globais
                const storedGlobal = localStorage.getItem(GLOBAL_KEY);
                if (storedGlobal) {
                    globalInfo = JSON.parse(storedGlobal);
                    if(globalInfo.partner) document.getElementById('partner').value = globalInfo.partner;
                    if(globalInfo.date) document.getElementById('appDate').value = globalInfo.date;
                    
                    const reqSelect = document.getElementById('requestor');
                    const reqOptions = Array.from(reqSelect.options).map(o => o.value);
                    if (globalInfo.requestor && reqOptions.includes(globalInfo.requestor)) {
                        reqSelect.value = globalInfo.requestor;
                    } else if (globalInfo.requestor) {
                        reqSelect.value = 'Outro';
                        toggleOtherRequestorInput();
                        document.getElementById('otherRequestorInput').value = globalInfo.requestor;
                    }

                    const appSelect = document.getElementById('applicator');
                    const appOptions = Array.from(appSelect.options).map(o => o.value);
                    if (globalInfo.applicator && appOptions.includes(globalInfo.applicator)) {
                        appSelect.value = globalInfo.applicator;
                    } else if (globalInfo.applicator) {
                        appSelect.value = 'Outro';
                        toggleOtherApplicatorInput();
                        document.getElementById('otherApplicatorInput').value = globalInfo.applicator;
                    }

                    if(globalInfo.startTime) document.getElementById('startTime').value = globalInfo.startTime;
                    if(globalInfo.endTime) document.getElementById('endTime').value = globalInfo.endTime;
                    if(globalInfo.duration) document.getElementById('totalDuration').value = globalInfo.duration;
                }

                // 2. Carregar Lista
                const storedData = localStorage.getItem(STORAGE_KEY);
                if (storedData) {
                    appData = JSON.parse(storedData);
                    appData.forEach(item => {
                        if (item.product && (!item.products || item.products.length === 0)) {
                            item.products = [{ name: item.product, dose: item.dosage, unit: 'ml', type: 'Biológico' }]; 
                        }
                    });
                    renderList();
                }
                renderHeaderAndSummary();
                updateDynamicTitle();
            } catch (e) { console.error("Erro ao carregar", e); }
        }
        
        function getFilteredData() {
            const currentPartner = globalInfo.partner || document.getElementById('partner').value; // Use global state
            if(!currentPartner) return [];
            return appData.filter(item => item.partner === currentPartner);
        }

        function getWeekNumber(d) {
            d = new Date(Date.UTC(d.getFullYear(), d.getMonth(), d.getDate()));
            d.setUTCDate(d.getUTCDate() + 4 - (d.getUTCDay() || 7));
            var yearStart = new Date(Date.UTC(d.getUTCFullYear(), 0, 1));
            return Math.ceil((((d - yearStart) / 86400000) + 1) / 7);
        }

        function updateDynamicTitle() {
            const displayPartner = globalInfo.partner || 'Parceiro';
            document.getElementById('reportTitle').innerHTML = `Resumo de Aplicações Fitossanitárias<br>${displayPartner}`;

            const dateObj = globalInfo.date ? new Date(globalInfo.date) : new Date();
            const day = String(dateObj.getUTCDate()).padStart(2, '0');
            const month = String(dateObj.getUTCMonth() + 1).padStart(2, '0');
            const year = dateObj.getUTCFullYear();
            const weekNumber = getWeekNumber(dateObj);
            document.getElementById('headerDateTime').innerText = `Gerado em: ${day}/${month}/${year} - Semana ${weekNumber}`;
        }

        // --- LÓGICA DE INPUTS "OUTRO" (SOLICITANTE/APLICADOR) ---
        function toggleOtherRequestorInput() {
            const select = document.getElementById('requestor');
            const customDiv = document.getElementById('requestor-custom-div');
            const customInput = document.getElementById('otherRequestorInput');
            if (select.value === 'Outro') {
                select.classList.add('hidden');
                customDiv.classList.remove('hidden');
                customInput.focus();
            }
        }
        function resetRequestorField() {
            const select = document.getElementById('requestor');
            const customDiv = document.getElementById('requestor-custom-div');
            const customInput = document.getElementById('otherRequestorInput');
            customInput.value = '';
            select.value = 'Marcio'; 
            select.selectedIndex = 0; 
            select.classList.remove('hidden');
            customDiv.classList.add('hidden');
        }
        function toggleOtherApplicatorInput() {
            const select = document.getElementById('applicator');
            const customDiv = document.getElementById('applicator-custom-div');
            const customInput = document.getElementById('otherApplicatorInput');
            if (select.value === 'Outro') {
                select.classList.add('hidden');
                customDiv.classList.remove('hidden');
                customInput.focus();
            }
        }
        function resetApplicatorField() {
            const select = document.getElementById('applicator');
            const customDiv = document.getElementById('applicator-custom-div');
            const customInput = document.getElementById('otherApplicatorInput');
            customInput.value = '';
            select.selectedIndex = 0; 
            select.classList.remove('hidden');
            customDiv.classList.add('hidden');
        }
        
        function handleCropChange() {
            const select = document.getElementById('crop');
            const otherInput = document.getElementById('otherCropInput');
            const blockLabel = document.getElementById('blockLabel');
            const blockInput = document.getElementById('blockId');
            if (select.value === 'Outros') {
                otherInput.classList.remove('hidden');
                otherInput.required = true;
                otherInput.focus();
            } else {
                otherInput.classList.add('hidden');
                otherInput.required = false;
                otherInput.value = ''; 
            }
            if (select.value === 'Pepino') {
                blockLabel.innerText = 'Nº Setor';
                blockInput.placeholder = 'Ex: 1';
            } else {
                blockLabel.innerText = 'Nº Bloco/Talhão';
                blockInput.placeholder = 'Ex: 1 - A';
            }
        }

        function clearBlockForm(clearAll = false) {
            // Este botão agora limpa apenas o formulário de blocos, a menos que especificado
            // Se o usuário clicar em "Limpar" no card do bloco, limpa só o bloco.
            // Se quiser limpar tudo (incluindo cabeçalho), precisaria de outro botão ou lógica.
            // O botão "Limpar" atual chama clearBlockForm(true) o que reseta tudo, mas o usuário pediu "independência".
            // Então vamos alterar o comportamento do botão "Limpar" no card do formulário para false.
            
            // Mas o botão no HTML chama clearBlockForm(true). Vou alterar para false no HTML.
            
            if (clearAll) {
                // Mantemos a opção de limpar tudo se necessário, mas o botão principal agora deve ser parcial
                document.getElementById('partner').selectedIndex = 0;
                resetRequestorField();
                resetApplicatorField();
                document.getElementById('startTime').value = '';
                document.getElementById('endTime').value = '';
                document.getElementById('totalDuration').value = '';
                updateGlobalState();
            }

            document.getElementById('crop').selectedIndex = 0;
            handleCropChange(); 
            document.getElementById('blockId').value = '';
            document.getElementById('targetPest').value = '';
            document.getElementById('productsContainer').innerHTML = '';
            addProductRow(); 
            document.getElementById('syrupVolume').value = '';
            document.getElementById('phValue').value = ''; 
            document.getElementById('notes').value = '';

            editingIndex = -1;
            const submitBtn = document.getElementById('submitBtn');
            const formTitle = document.getElementById('formTitle');
            const formContainer = document.getElementById('formContainer');

            submitBtn.innerHTML = '<i data-lucide="plus-circle" class="w-4 h-4"></i> <span>Registrar Aplicação</span>';
            submitBtn.classList.remove('bg-blue-600', 'hover:bg-blue-700');
            submitBtn.classList.add('bg-slate-800', 'hover:bg-slate-900');
            
            formTitle.innerHTML = '<i data-lucide="spray-can" class="text-blue-600"></i> Nova Aplicação';
            formContainer.classList.remove('border-blue-300', 'ring-2', 'ring-blue-100');
            
            lucide.createIcons();
        }

        // --- ADD ITEM ---
        function addItem(e) {
            e.preventDefault();
            
            const selectValue = document.getElementById('crop').value;
            let finalCropName = selectValue;
            if (selectValue === 'Outros') {
                finalCropName = document.getElementById('otherCropInput').value;
                if (!finalCropName.trim()) { alert("Digite o nome da cultura."); return; }
            }

            const productsList = [];
            let hasError = false;
            const rows = document.querySelectorAll('.product-row');
            if (rows.length === 0) { alert("Adicione pelo menos um produto."); return; }

            for (const row of rows) {
                const prodSelect = row.querySelector('.prod-name-select');
                let name = prodSelect.value;
                if (prodSelect.classList.contains('hidden')) name = row.querySelector('.prod-name-custom-input').value.trim();

                const typeSelect = row.querySelector('.prod-type-select');
                let type = typeSelect.value;
                if (typeSelect.classList.contains('hidden')) type = row.querySelector('.prod-type-custom-input').value.trim();

                const dose = row.querySelector('.prod-dose-input').value.trim();
                const unit = row.querySelector('.prod-unit-input').value;

                if (!name || name === "" || !type || type === "" || !dose) { hasError = true; break; }
                productsList.push({ name, type, dose, unit });
            }

            if (hasError) { alert("⚠️ Atenção: Por favor, selecione o Produto, o Tipo e informe a Dose."); return; }

            // Usa GLOBAL INFO para o cabeçalho do item
            const newItem = {
                partner: globalInfo.partner, 
                date: globalInfo.date,
                requestor: globalInfo.requestor,
                applicator: globalInfo.applicator,
                startTime: globalInfo.startTime,
                endTime: globalInfo.endTime,
                duration: globalInfo.duration,

                crop: finalCropName,
                block: document.getElementById('blockId').value,
                target: document.getElementById('targetPest').value,
                products: productsList,
                volume: parseFloat(document.getElementById('syrupVolume').value) || 0,
                ph: document.getElementById('phValue').value,
                notes: document.getElementById('notes').value
            };

            if (editingIndex >= 0) {
                appData[editingIndex] = newItem;
                editingIndex = -1; 
            } else {
                appData.push(newItem);
            }
            
            saveToStorage();
            clearBlockForm(false); // Limpa APENAS os campos do bloco
            renderReport(); 
            renderList();
        }

        function editItem(index) {
            const item = appData[index];
            editingIndex = index; 

            // Dados Gerais (Header) - Opcional: Atualizar o global com o do item editado?
            // Para manter a independência, ao editar um item, carregamos seus dados NO FORMULÁRIO GLOBAL também
            // para que o usuário veja o contexto daquele item.
            document.getElementById('partner').value = item.partner;
            document.getElementById('appDate').value = item.date;
            
            // Solicitante
            const reqSelect = document.getElementById('requestor');
            const reqOptions = Array.from(reqSelect.options).map(o => o.value);
            if (reqOptions.includes(item.requestor)) {
                reqSelect.value = item.requestor;
                reqSelect.classList.remove('hidden');
                document.getElementById('requestor-custom-div').classList.add('hidden');
            } else {
                reqSelect.value = 'Outro';
                toggleOtherRequestorInput();
                document.getElementById('otherRequestorInput').value = item.requestor;
            }

            // Aplicador
            const appSelect = document.getElementById('applicator');
            const appOptions = Array.from(appSelect.options).map(o => o.value);
            if (appOptions.includes(item.applicator)) {
                appSelect.value = item.applicator;
                appSelect.classList.remove('hidden');
                document.getElementById('applicator-custom-div').classList.add('hidden');
            } else {
                appSelect.value = 'Outro';
                toggleOtherApplicatorInput();
                document.getElementById('otherApplicatorInput').value = item.applicator;
            }

            document.getElementById('startTime').value = item.startTime || '';
            document.getElementById('endTime').value = item.endTime || '';
            calculateDuration(); 
            
            // Atualiza estado global para refletir o item sendo editado
            updateGlobalState();

            // Dados do Bloco
            const cropSelect = document.getElementById('crop');
            const otherInput = document.getElementById('otherCropInput');
            const options = Array.from(cropSelect.options).map(o => o.value);
            if (options.includes(item.crop)) {
                cropSelect.value = item.crop;
            } else {
                cropSelect.value = 'Outros';
                otherInput.value = item.crop; 
            }
            handleCropChange();

            document.getElementById('blockId').value = item.block;
            document.getElementById('targetPest').value = item.target;
            
            const container = document.getElementById('productsContainer');
            container.innerHTML = '';
            if (item.products && item.products.length > 0) {
                item.products.forEach(p => addProductRow(p.name, p.dose, p.unit, p.type));
            } else {
                addProductRow(item.product, item.dosage, 'ml', 'Biológico');
            }

            document.getElementById('syrupVolume').value = item.volume;
            document.getElementById('phValue').value = item.ph || '';
            document.getElementById('notes').value = item.notes || '';
            
            const submitBtn = document.getElementById('submitBtn');
            const formTitle = document.getElementById('formTitle');
            const formContainer = document.getElementById('formContainer');

            submitBtn.innerHTML = '<i data-lucide="save" class="w-4 h-4"></i> <span>Salvar Alterações</span>';
            submitBtn.classList.remove('bg-slate-800', 'hover:bg-slate-900');
            submitBtn.classList.add('bg-blue-600', 'hover:bg-blue-700');

            formTitle.innerHTML = '<i data-lucide="pencil" class="text-blue-600"></i> Editando Registro';
            formContainer.classList.add('border-blue-300', 'ring-2', 'ring-blue-100');
            formContainer.scrollIntoView({ behavior: 'smooth', block: 'center' });
            lucide.createIcons();
        }

        function removeItem(index) {
            if (editingIndex === index) {
                clearBlockForm(false); 
                editingIndex = -1;
            }
            appData.splice(index, 1);
            saveToStorage();
            renderReport();
            renderList();
        }

        function renderHeaderAndSummary() {
            const summaryContainer = document.getElementById('operationalSummary');
            summaryContainer.classList.remove('hidden');

            const req = globalInfo.requestor || '-';
            const app = globalInfo.applicator || '-';
            
            let timeRange = "Não informado";
            if (globalInfo.startTime) {
                timeRange = `Início: ${globalInfo.startTime}`;
                if (globalInfo.endTime) {
                    timeRange = `${globalInfo.startTime} às ${globalInfo.endTime}`;
                    if (globalInfo.duration) timeRange += ` (${globalInfo.duration})`;
                }
            }

            summaryContainer.innerHTML = `
                <div class="flex flex-col gap-2 text-xs">
                    <div class="flex justify-between items-start border-b border-slate-200 pb-2">
                        <div class="flex flex-col gap-1 w-2/3">
                            <span class="text-[9px] uppercase font-bold text-slate-400 tracking-wider">Responsáveis</span>
                            <div class="flex flex-col sm:flex-row gap-2 sm:gap-4">
                                <span class="text-slate-600 font-medium">Solicitante: <b class="text-slate-800">${req}</b></span>
                                <span class="text-slate-600 font-medium">Aplicador: <b class="text-slate-800">${app}</b></span>
                            </div>
                        </div>
                        <div class="text-right w-1/3">
                            <span class="text-[9px] uppercase font-bold text-slate-400 tracking-wider block mb-1">Tempo de Aplicação</span>
                            <span class="font-bold text-slate-700">${timeRange}</span>
                        </div>
                    </div>
                </div>
            `;
        }

        function renderReport() {
            const container = document.getElementById('reportContent');
            const footerContainer = document.getElementById('operationalFooter');
            container.innerHTML = '';
            let totalApps = 0;
            const displayData = getFilteredData();

            if (displayData.length === 0) {
                container.innerHTML = `<div class="p-8 text-center text-slate-400 text-xs italic leading-relaxed h-full flex flex-col items-center justify-center"><i data-lucide="clipboard-list" class="mb-2 w-8 h-8 opacity-20"></i><span>Adicione registros.</span></div>`;
            } else {
                displayData.sort((a, b) => a.block.localeCompare(b.block, undefined, {numeric: true, sensitivity: 'base'}));
                displayData.forEach((item) => { 
                    totalApps++;
                    let locationLabel = "Bloco";
                    if (item.crop && item.crop.toLowerCase().includes('pepino')) locationLabel = "Setor";

                    let productsHtml = '';
                    if (item.products && item.products.length > 0) {
                        productsHtml = `<div class="mt-2 space-y-1">`;
                        item.products.forEach(p => {
                            const unitDisplay = p.unit ? p.unit : '';
                            let typeClass = "text-slate-400";
                            if(p.type === 'Biológico') typeClass = "text-green-600";
                            if(p.type === 'Químico') typeClass = "text-red-600";
                            if(p.type === 'Nutricional') typeClass = "text-blue-600";
                            if(p.type === 'Natural' || p.type === 'Repelente') typeClass = "text-emerald-600";
                            if(p.type === 'Adjuvantes') typeClass = "text-amber-600";
                            if(['Inseticidas', 'Fungicidas', 'Herbicidas', 'Acaricidas', 'Nematicidas', 'Bactericidas', 'Rodenticidas', 'Desfolhantes', 'Químico'].includes(p.type)) typeClass = "text-red-600";

                            productsHtml += `
                                <div class="flex justify-between items-center text-xs border-b border-slate-50 pb-1 last:border-0">
                                    <div class="flex items-center gap-1">
                                        <span class="font-bold text-slate-700">• ${p.name}</span>
                                        <span class="text-[9px] uppercase font-bold ${typeClass}">[${p.type || 'Geral'}]</span>
                                    </div>
                                    <span class="font-medium text-slate-600">${p.dose} ${unitDisplay}</span>
                                </div>`;
                        });
                        productsHtml += `</div>`;
                    }
                    // ... (resto do render igual)
                    const html = `
                    <div class="p-5 hover:bg-slate-50 transition-colors group border-b border-slate-50 last:border-0">
                        <div class="flex flex-col mb-2">
                            <div class="flex items-start justify-between mt-1">
                                <div class="w-full">
                                    <div class="flex justify-between items-center mb-2">
                                        <span class="text-sm font-bold text-slate-700">${locationLabel} ${item.block} • ${item.crop}</span>
                                        <div class="text-xs font-bold text-slate-600 flex items-center gap-1"><span class="text-orange-600 text-sm font-extrabold">Alvo:</span> ${item.target}</div>
                                    </div>
                                    <div class="bg-slate-50/50 rounded-lg border border-slate-100 p-2">
                                        <span class="text-[9px] font-bold text-slate-400 uppercase tracking-wider block mb-1 text-center">Produtos & Dosagens</span>
                                        ${productsHtml}
                                    </div>
                                    <div class="mt-2 flex justify-end items-center gap-3">
                                        ${item.ph ? `<span class="text-[10px] font-bold text-red-600">PH: ${item.ph}</span>` : ''}
                                        <span class="text-[10px] font-bold text-blue-600">Volume Calda: ${item.volume} L</span>
                                    </div>
                                </div>
                            </div>
                            ${item.notes ? `<div class="mt-2 text-[10px] text-slate-400 italic border-l-2 border-slate-200 pl-2">Obs: ${item.notes}</div>` : ''}
                        </div>
                    </div>`;
                    container.innerHTML += html;
                });
            }
            
            footerContainer.innerHTML = `
                <div class="bg-slate-100 rounded-xl p-4 flex justify-center items-center relative overflow-hidden">
                    <div class="absolute top-0 right-0 w-16 h-16 bg-slate-200/50 rounded-full -mr-8 -mt-8 pointer-events-none"></div>
                    <div class="text-center">
                        <div class="text-[10px] text-slate-500 font-bold uppercase mb-0.5">Total Aplicações</div>
                        <div class="text-xl font-extrabold text-slate-800">${totalApps}</div>
                    </div>
                </div>`;
            
            lucide.createIcons();
            renderHeaderAndSummary(); // Atualiza header com dados globais
        }

        // ... (Export functions maintained)
    </script>
</body>
</html>
